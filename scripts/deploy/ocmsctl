#!/bin/bash
# Copyright (c) 2025-2026 Oleg Ivanchenko
# SPDX-License-Identifier: GPL-3.0-or-later
#
# oCMS Instance Control Tool (non-systemd)
# For testing, debugging, and quick management of oCMS instances.
# For production, use: systemctl start/stop/restart ocms@<site-id>
#
# Usage: ocmsctl <command> <site-id> [options]
#
# Commands:
#   start   <site-id> [--foreground]  Start the instance
#   stop    <site-id>                 Stop the instance
#   restart <site-id>                 Restart the instance
#   status  <site-id>                 Show instance status
#   logs    <site-id> [--follow]      View instance logs
#   list                              List all registered sites
#   health  <site-id>                 Check health endpoint

set -e

BINARY_PATH="/opt/ocms/bin/ocms"
SITES_CONF="/etc/ocms/sites.conf"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

echo_info()  { echo -e "${GREEN}[INFO]${NC} $1"; }
echo_warn()  { echo -e "${YELLOW}[WARN]${NC} $1"; }
echo_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# --- Site Resolution ---

resolve_site() {
    local site_id="$1"

    if [ ! -f "$SITES_CONF" ]; then
        echo_error "Site registry not found: $SITES_CONF"
        echo "       Run setup-site.sh first to register sites."
        exit 1
    fi

    local line
    line=$(grep "^${site_id} " "$SITES_CONF" 2>/dev/null || true)

    if [ -z "$line" ]; then
        echo_error "Site '$site_id' not found in $SITES_CONF"
        echo ""
        echo "Registered sites:"
        grep -v '^#' "$SITES_CONF" | grep -v '^$' | awk '{printf "  %-30s (port %s)\n", $1, $4}'
        exit 1
    fi

    SITE_VHOST=$(echo "$line" | awk '{print $2}')
    SITE_USER=$(echo "$line" | awk '{print $3}')
    SITE_PORT=$(echo "$line" | awk '{print $4}')
    SITE_DIR="$SITE_VHOST/ocms"
    SITE_PID="$SITE_DIR/ocms.pid"
    SITE_LOG="$SITE_DIR/logs/ocms.log"
    SITE_ENV="$SITE_DIR/.env"
}

is_pid_running() {
    local pid="$1"
    [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null
}

get_pid() {
    if [ -f "$SITE_PID" ]; then
        cat "$SITE_PID"
    fi
}

is_systemd_active() {
    local site_id="$1"
    systemctl is-active --quiet "ocms@${site_id}" 2>/dev/null
}

# --- Commands ---

cmd_start() {
    local site_id="$1"
    local foreground="${2:-}"

    resolve_site "$site_id"

    # Check if already running under systemd
    if is_systemd_active "$site_id"; then
        echo_error "Site '$site_id' is running under systemd."
        echo "       Use: sudo systemctl stop ocms@$site_id"
        echo "       Then retry with ocmsctl."
        exit 1
    fi

    # Check if already running via PID file
    local pid
    pid=$(get_pid)
    if is_pid_running "$pid"; then
        echo_error "Site '$site_id' is already running (PID: $pid)"
        exit 1
    fi

    # Clean stale PID file
    [ -f "$SITE_PID" ] && rm -f "$SITE_PID"

    # Validate
    if [ ! -x "$BINARY_PATH" ]; then
        echo_error "Binary not found: $BINARY_PATH"
        exit 1
    fi
    if [ ! -f "$SITE_ENV" ]; then
        echo_error "Env file not found: $SITE_ENV"
        exit 1
    fi

    echo_info "Starting site '$site_id' (port $SITE_PORT)..."

    if [ "$foreground" = "--foreground" ]; then
        echo_info "Running in foreground (Ctrl+C to stop)"
        sudo -u "$SITE_USER" bash -c "
            cd '$SITE_DIR'
            set -a; source '$SITE_ENV'; set +a
            exec '$BINARY_PATH'
        "
    else
        sudo -u "$SITE_USER" bash -c "
            cd '$SITE_DIR'
            set -a; source '$SITE_ENV'; set +a
            nohup '$BINARY_PATH' >> '$SITE_LOG' 2>&1 &
            echo \$! > '$SITE_PID'
        "

        sleep 2

        pid=$(get_pid)
        if is_pid_running "$pid"; then
            echo_info "Started (PID: $pid)"
            echo "       Logs: $SITE_LOG"

            # Quick health check
            if curl -sf --max-time 5 "http://127.0.0.1:${SITE_PORT}/health" > /dev/null 2>&1; then
                echo_info "Health check: OK"
            else
                echo_warn "Health check: not yet responding (may still be starting)"
            fi
        else
            echo_error "Failed to start. Check logs:"
            echo "       tail -20 $SITE_LOG"
            [ -f "$SITE_PID" ] && rm -f "$SITE_PID"
            exit 1
        fi
    fi
}

cmd_stop() {
    local site_id="$1"

    resolve_site "$site_id"

    # Check if running under systemd
    if is_systemd_active "$site_id"; then
        echo_error "Site '$site_id' is managed by systemd."
        echo "       Use: sudo systemctl stop ocms@$site_id"
        exit 1
    fi

    local pid
    pid=$(get_pid)

    if [ -z "$pid" ]; then
        echo_warn "Site '$site_id' is not running (no PID file)"
        return 0
    fi

    if ! is_pid_running "$pid"; then
        echo_warn "Site '$site_id' is not running (stale PID: $pid)"
        rm -f "$SITE_PID"
        return 0
    fi

    echo_info "Stopping site '$site_id' (PID: $pid)..."
    kill -SIGTERM "$pid"

    # Wait for graceful shutdown (up to 30 seconds)
    local waited=0
    while is_pid_running "$pid" && [ $waited -lt 30 ]; do
        sleep 1
        waited=$((waited + 1))
    done

    if is_pid_running "$pid"; then
        echo_warn "Process didn't stop gracefully, sending SIGKILL..."
        kill -SIGKILL "$pid" 2>/dev/null || true
        sleep 1
    fi

    rm -f "$SITE_PID"
    echo_info "Stopped."
}

cmd_restart() {
    local site_id="$1"

    resolve_site "$site_id"

    # Check if running under systemd
    if is_systemd_active "$site_id"; then
        echo_error "Site '$site_id' is managed by systemd."
        echo "       Use: sudo systemctl restart ocms@$site_id"
        exit 1
    fi

    cmd_stop "$site_id" 2>/dev/null || true
    sleep 1
    cmd_start "$site_id"
}

cmd_status() {
    local site_id="$1"

    resolve_site "$site_id"

    echo ""
    echo -e "${BOLD}Site:${NC}      $site_id"
    echo -e "${BOLD}Domain:${NC}    $(basename "$SITE_VHOST")"
    echo -e "${BOLD}User:${NC}      $SITE_USER"
    echo -e "${BOLD}Port:${NC}      $SITE_PORT"
    echo -e "${BOLD}Directory:${NC} $SITE_DIR"

    # Check status
    if is_systemd_active "$site_id"; then
        echo -e "${BOLD}Status:${NC}    ${GREEN}RUNNING${NC} (systemd)"
        echo -e "${BOLD}Manage:${NC}   systemctl stop/restart ocms@$site_id"
    else
        local pid
        pid=$(get_pid)
        if is_pid_running "$pid"; then
            echo -e "${BOLD}Status:${NC}    ${GREEN}RUNNING${NC} (PID: $pid, ocmsctl)"
            echo -e "${BOLD}Manage:${NC}   ocmsctl stop/restart $site_id"
        else
            echo -e "${BOLD}Status:${NC}    ${RED}STOPPED${NC}"
            [ -f "$SITE_PID" ] && rm -f "$SITE_PID"
        fi
    fi

    # Health check
    echo -n -e "${BOLD}Health:${NC}    "
    local http_code
    http_code=$(curl -sf -o /dev/null -w "%{http_code}" --max-time 5 "http://127.0.0.1:${SITE_PORT}/health" 2>/dev/null || echo "000")
    if [ "$http_code" = "200" ]; then
        echo -e "${GREEN}OK${NC} (HTTP $http_code)"
    else
        echo -e "${RED}UNREACHABLE${NC} (HTTP $http_code)"
    fi

    echo ""
}

cmd_logs() {
    local site_id="$1"
    local follow="${2:-}"

    resolve_site "$site_id"

    # If running under systemd, use journalctl
    if is_systemd_active "$site_id"; then
        echo_info "Reading systemd journal for ocms@$site_id..."
        if [ "$follow" = "--follow" ] || [ "$follow" = "-f" ]; then
            journalctl -u "ocms@${site_id}" -f
        else
            journalctl -u "ocms@${site_id}" -n 100 --no-pager
        fi
        return
    fi

    # Otherwise use log file
    if [ ! -f "$SITE_LOG" ]; then
        echo_warn "No log file found: $SITE_LOG"
        echo "       If running under systemd, use: journalctl -u ocms@$site_id"
        return
    fi

    if [ "$follow" = "--follow" ] || [ "$follow" = "-f" ]; then
        echo_info "Following $SITE_LOG (Ctrl+C to stop)"
        tail -f "$SITE_LOG"
    else
        tail -100 "$SITE_LOG"
    fi
}

cmd_list() {
    if [ ! -f "$SITES_CONF" ]; then
        echo_warn "No sites registered. Run setup-site.sh to add sites."
        exit 0
    fi

    echo ""
    printf "${BOLD}%-28s %-18s %-8s %-18s${NC}\n" "SITE ID" "USER" "PORT" "STATUS"
    printf "%-28s %-18s %-8s %-18s\n" "---" "---" "---" "---"

    while IFS=' ' read -r site_id vhost_path user port; do
        # Skip comments and empty lines
        [[ "$site_id" =~ ^#.*$ ]] && continue
        [ -z "$site_id" ] && continue

        local status
        local status_color

        if systemctl is-active --quiet "ocms@${site_id}" 2>/dev/null; then
            status="running (systemd)"
            status_color="$GREEN"
        else
            local pid_file="$vhost_path/ocms/ocms.pid"
            local pid=""
            [ -f "$pid_file" ] && pid=$(cat "$pid_file")
            if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
                status="running (pid:$pid)"
                status_color="$GREEN"
            else
                status="stopped"
                status_color="$RED"
                # Clean stale PID
                [ -f "$pid_file" ] && rm -f "$pid_file"
            fi
        fi

        printf "%-28s %-18s %-8s ${status_color}%-18s${NC}\n" "$site_id" "$user" "$port" "$status"
    done < "$SITES_CONF"

    echo ""
}

cmd_health() {
    local site_id="$1"

    resolve_site "$site_id"

    local url="http://127.0.0.1:${SITE_PORT}/health"
    echo -n "Health check ($url): "

    local http_code
    http_code=$(curl -sf -o /dev/null -w "%{http_code}" --max-time 10 "$url" 2>/dev/null || echo "000")

    if [ "$http_code" = "200" ]; then
        echo -e "${GREEN}OK${NC} (HTTP $http_code)"
    else
        echo -e "${RED}FAILED${NC} (HTTP $http_code)"
        exit 1
    fi
}

# --- Usage ---

print_usage() {
    echo "oCMS Instance Control Tool"
    echo ""
    echo "Usage: ocmsctl <command> <site-id> [options]"
    echo ""
    echo "Commands:"
    echo "  start   <site-id> [--foreground]  Start the instance"
    echo "  stop    <site-id>                 Stop the instance"
    echo "  restart <site-id>                 Restart the instance"
    echo "  status  <site-id>                 Show instance status"
    echo "  logs    <site-id> [--follow|-f]   View instance logs"
    echo "  list                              List all registered sites"
    echo "  health  <site-id>                 Check health endpoint"
    echo ""
    echo "Examples:"
    echo "  ocmsctl start example_com"
    echo "  ocmsctl start example_com --foreground"
    echo "  ocmsctl stop example_com"
    echo "  ocmsctl logs example_com --follow"
    echo "  ocmsctl list"
    echo ""
    echo "For production use: systemctl start/stop/restart ocms@<site-id>"
}

# --- Main ---

COMMAND="${1:-}"
SITE_ID="${2:-}"
OPTION="${3:-}"

case "$COMMAND" in
    start)
        [ -z "$SITE_ID" ] && { echo_error "Missing site-id"; print_usage; exit 1; }
        cmd_start "$SITE_ID" "$OPTION"
        ;;
    stop)
        [ -z "$SITE_ID" ] && { echo_error "Missing site-id"; print_usage; exit 1; }
        cmd_stop "$SITE_ID"
        ;;
    restart)
        [ -z "$SITE_ID" ] && { echo_error "Missing site-id"; print_usage; exit 1; }
        cmd_restart "$SITE_ID"
        ;;
    status)
        [ -z "$SITE_ID" ] && { echo_error "Missing site-id"; print_usage; exit 1; }
        cmd_status "$SITE_ID"
        ;;
    logs)
        [ -z "$SITE_ID" ] && { echo_error "Missing site-id"; print_usage; exit 1; }
        cmd_logs "$SITE_ID" "$OPTION"
        ;;
    list)
        cmd_list
        ;;
    health)
        [ -z "$SITE_ID" ] && { echo_error "Missing site-id"; print_usage; exit 1; }
        cmd_health "$SITE_ID"
        ;;
    -h|--help|help|"")
        print_usage
        ;;
    *)
        echo_error "Unknown command: $COMMAND"
        print_usage
        exit 1
        ;;
esac
