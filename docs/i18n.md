# Internationalization (i18n)

OCMS includes a comprehensive internationalization system for the admin interface and modules. This document describes how translations work and how to add new translations.

## Overview

The i18n system supports:

- Admin interface translations
- Module-embedded translations
- **Theme-level translations** (override global frontend strings)
- Multiple languages (English, Russian by default)
- JSON Schema validation for translation files
- Dynamic language switching in admin UI

## Translation File Format

All translation files use a JSON schema-based format:

```json
{
    "$schema": "../../../../.schema/i18n-schema.json",
    "language": "en",
    "messages": [
        {
            "id": "module.key",
            "message": "Original text (English)",
            "translation": "Translated text"
        }
    ]
}
```

### Fields

| Field | Required | Description |
|-------|----------|-------------|
| `$schema` | No | Path to JSON schema for validation |
| `language` | Yes | ISO 639-1 language code (e.g., `en`, `ru`) |
| `messages` | Yes | Array of translation entries |
| `messages[].id` | Yes | Unique identifier using dot notation |
| `messages[].message` | No | Original text (for reference) |
| `messages[].translation` | Yes | Translated text |

### Naming Conventions

Translation IDs use dot notation with the following pattern:

```
{namespace}.{category}.{key}
```

Examples:
- `hcaptcha.title` - Module title
- `hcaptcha.error_required` - Error message
- `analytics.ga4_measurement_id` - Form field label
- `nav.dashboard` - Navigation item

## Core Translations

Core admin translations are located in:

```
internal/i18n/locales/
├── en/
│   └── messages.json
└── ru/
    └── messages.json
```

## Module Translations

Each module can include its own embedded translations.

### Directory Structure

```
modules/{module_name}/
├── module.go
├── locales/
│   ├── en/
│   │   └── messages.json
│   └── ru/
│       └── messages.json
└── ...
```

### Embedding Translations

In your module's `module.go`:

```go
import "embed"

//go:embed locales
var localesFS embed.FS

// TranslationsFS returns the embedded filesystem containing module translations.
func (m *Module) TranslationsFS() embed.FS {
    return localesFS
}
```

### Creating Translation Files

1. Create the directory structure:

```bash
mkdir -p modules/mymodule/locales/en
mkdir -p modules/mymodule/locales/ru
```

2. Create `modules/mymodule/locales/en/messages.json`:

```json
{
    "$schema": "../../../../.schema/i18n-schema.json",
    "language": "en",
    "messages": [
        {"id": "mymodule.title", "message": "My Module", "translation": "My Module"},
        {"id": "mymodule.description", "message": "Module description", "translation": "Module description"},
        {"id": "mymodule.save_button", "message": "Save", "translation": "Save"},
        {"id": "mymodule.success_save", "message": "Settings saved", "translation": "Settings saved"},
        {"id": "mymodule.error_save", "message": "Failed to save", "translation": "Failed to save"}
    ]
}
```

3. Create `modules/mymodule/locales/ru/messages.json`:

```json
{
    "$schema": "../../../../.schema/i18n-schema.json",
    "language": "ru",
    "messages": [
        {"id": "mymodule.title", "message": "My Module", "translation": "Мой модуль"},
        {"id": "mymodule.description", "message": "Module description", "translation": "Описание модуля"},
        {"id": "mymodule.save_button", "message": "Save", "translation": "Сохранить"},
        {"id": "mymodule.success_save", "message": "Settings saved", "translation": "Настройки сохранены"},
        {"id": "mymodule.error_save", "message": "Failed to save", "translation": "Не удалось сохранить"}
    ]
}
```

## Theme Translations

Themes can include their own translation overrides, allowing theme authors to customize frontend strings without modifying global translation files.

### Directory Structure

```
themes/{theme_name}/
├── theme.json
├── templates/
├── static/
└── locales/           # Optional theme translations
    ├── en/
    │   └── messages.json
    └── ru/
        └── messages.json
```

### How It Works

1. **Priority**: Theme translations take precedence over global translations
2. **Fallback**: If a key isn't found in theme translations, global translations are used
3. **Optional**: Themes work without a `locales/` directory (uses global translations only)
4. **Selective**: Themes only need to include strings they want to override

### Example Theme Translation

`themes/mytheme/locales/en/messages.json`:

```json
{
    "$schema": "../../../../../../.schema/i18n-schema.json",
    "language": "en",
    "messages": [
        {"id": "frontend.read_more", "message": "Read more", "translation": "Continue reading →"},
        {"id": "frontend.all_posts", "message": "All Posts", "translation": "Browse Articles"}
    ]
}
```

### Using Theme Translations in Templates

Theme templates should use `TTheme` instead of `T` for frontend strings:

```html
{{/* Theme templates - uses theme translations with global fallback */}}
<a href="{{.URL}}">{{TTheme .LangCode "frontend.read_more"}}</a>
<h1>{{TTheme .LangCode "frontend.all_posts"}}</h1>

{{/* Pagination example */}}
<span>{{TTheme $.LangCode "pagination.page"}} {{.Pagination.CurrentPage}}</span>
```

### TTheme vs T

| Function | Use Case | Fallback |
|----------|----------|----------|
| `TTheme` | Theme templates (frontend) | Theme → Global |
| `T` | Admin templates, modules | Global only |

### Benefits

- **Portable themes**: Themes are self-contained with their own translations
- **No duplication**: Only override strings that differ from global
- **Theme-specific terminology**: Each theme can use its own voice/style
- **Easy distribution**: Install a theme = get all its translations

## Using Translations in Templates

Use the `T` function in admin templates:

```html
<h1>{{T .AdminLang "mymodule.title"}}</h1>
<p>{{T .AdminLang "mymodule.description"}}</p>
<button type="submit">{{T .AdminLang "mymodule.save_button"}}</button>
```

## Using Translations in Go Code

```go
import "ocms-go/internal/i18n"

// Get translation
message := i18n.T(lang, "mymodule.success_save")

// With format arguments
message := i18n.T(lang, "mymodule.welcome", userName)
```

## Adding a New Language

1. Create language directories in core and each module:

```bash
# Core translations
mkdir -p internal/i18n/locales/de

# Module translations
mkdir -p modules/hcaptcha/locales/de
mkdir -p modules/analytics/locales/de
# ... repeat for each module
```

2. Copy English files as templates:

```bash
cp internal/i18n/locales/en/messages.json internal/i18n/locales/de/messages.json
```

3. Update the `language` field and translate each entry

4. Register the language in the database or configuration

## JSON Schema Validation

The project includes a JSON schema for validation at `.schema/i18n-schema.json`.

### VS Code Setup

Add to `.vscode/settings.json`:

```json
{
    "json.schemas": [
        {
            "fileMatch": ["**/locales/*/messages.json"],
            "url": "./.schema/i18n-schema.json"
        }
    ]
}
```

### Validation

The schema validates:
- Required fields (`language`, `messages`)
- Language code format (ISO 639-1)
- Message object structure
- No additional properties

## Best Practices

### ID Naming

- Use lowercase with dots as separators
- Start with module/namespace name
- Group related translations:
  - `module.title` - Page/section title
  - `module.description` - Description text
  - `module.field_name` - Form field labels
  - `module.field_name_help` - Help text for fields
  - `module.error_*` - Error messages
  - `module.success_*` - Success messages
  - `module.button_*` or `module.*_button` - Button labels

### Translation Tips

- Keep translations concise
- Maintain consistent terminology
- Consider text expansion (some languages are longer)
- Use placeholders for dynamic content: `"Welcome, %s"`

### File Organization

- One translation file per language per module
- Keep message order consistent across languages
- Include the `message` field for translator reference

## Module Translation Loading

Translations are loaded automatically when a module is initialized:

1. Module returns `TranslationsFS()` with embedded locales
2. Module system reads each language directory
3. Translations are merged with core translations
4. Translations become available via `i18n.T()`

## Troubleshooting

### Translations Not Appearing

1. Check the translation ID matches exactly
2. Verify the file is valid JSON
3. Ensure the module implements `TranslationsFS()`
4. Check server logs for loading errors

### Schema Validation Errors

1. Verify `$schema` path is correct relative to file location
2. Check all required fields are present
3. Ensure `language` matches directory name
4. Verify message objects have `id` and `translation`

## Supported Languages

| Code | Language |
|------|----------|
| `en` | English |
| `ru` | Russian |

Add new languages by following the "Adding a New Language" section above.
