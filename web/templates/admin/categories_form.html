{{define "content"}}
<div class="page-header">
    <div>
        <h1 class="page-title">{{if .Data.IsEdit}}Edit Category{{else}}New Category{{end}}</h1>
        <p class="page-description">{{if .Data.IsEdit}}Update category details{{else}}Create a new category for organizing content{{end}}</p>
    </div>
    <div class="page-actions">
        <a href="/admin/categories" class="btn btn-outline">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            Back to Categories
        </a>
    </div>
</div>

<div class="card">
    <form
        method="POST"
        action="{{if .Data.IsEdit}}/admin/categories/{{.Data.Category.ID}}{{else}}/admin/categories{{end}}"
        class="card-body"
        x-data="categoryForm()"
    >
        {{if .Data.IsEdit}}
        <input type="hidden" name="_method" value="PUT">
        {{end}}

        <div class="form-grid">
            <!-- Name -->
            <div class="form-group">
                <label for="name" class="form-label">
                    Name <span class="required">*</span>
                </label>
                <input
                    type="text"
                    id="name"
                    name="name"
                    class="form-input {{if .Data.Errors.name}}is-invalid{{end}}"
                    value="{{if .Data.FormValues.name}}{{.Data.FormValues.name}}{{else if .Data.Category}}{{.Data.Category.Name}}{{end}}"
                    placeholder="Enter category name"
                    required
                    @input="generateSlug($event.target.value)"
                >
                {{if .Data.Errors.name}}
                <span class="form-error">{{.Data.Errors.name}}</span>
                {{else}}
                <span class="form-hint">Display name for this category</span>
                {{end}}
            </div>

            <!-- Slug -->
            <div class="form-group">
                <label for="slug" class="form-label">
                    Slug <span class="required">*</span>
                </label>
                <input
                    type="text"
                    id="slug"
                    name="slug"
                    class="form-input {{if .Data.Errors.slug}}is-invalid{{end}}"
                    value="{{if .Data.FormValues.slug}}{{.Data.FormValues.slug}}{{else if .Data.Category}}{{.Data.Category.Slug}}{{end}}"
                    placeholder="category-slug"
                    x-model="slug"
                    @input="slugEdited = true"
                >
                {{if .Data.Errors.slug}}
                <span class="form-error">{{.Data.Errors.slug}}</span>
                {{else}}
                <span class="form-hint">URL-friendly identifier (auto-generated from name)</span>
                {{end}}
            </div>
        </div>

        <!-- Description -->
        <div class="form-group">
            <label for="description" class="form-label">Description</label>
            <textarea
                id="description"
                name="description"
                class="form-input {{if .Data.Errors.description}}is-invalid{{end}}"
                rows="3"
                placeholder="Optional description of this category"
            >{{if .Data.FormValues.description}}{{.Data.FormValues.description}}{{else if and .Data.Category .Data.Category.Description.Valid}}{{.Data.Category.Description.String}}{{end}}</textarea>
            {{if .Data.Errors.description}}
            <span class="form-error">{{.Data.Errors.description}}</span>
            {{else}}
            <span class="form-hint">Brief description of what content this category contains</span>
            {{end}}
        </div>

        <div class="form-grid">
            <!-- Parent Category -->
            <div class="form-group">
                <label for="parent_id" class="form-label">Parent Category</label>
                <select
                    id="parent_id"
                    name="parent_id"
                    class="form-input {{if .Data.Errors.parent_id}}is-invalid{{end}}"
                >
                    <option value="">No parent (root category)</option>
                    {{$currentID := 0}}
                    {{if .Data.Category}}{{$currentID = .Data.Category.ID}}{{end}}
                    {{$currentParentID := ""}}
                    {{if .Data.FormValues.parent_id}}
                        {{$currentParentID = .Data.FormValues.parent_id}}
                    {{else if and .Data.Category .Data.Category.ParentID.Valid}}
                        {{$currentParentID = printf "%d" .Data.Category.ParentID.Int64}}
                    {{end}}
                    {{range .Data.AllCategories}}
                        {{if ne .Category.ID $currentID}}
                        <option
                            value="{{.Category.ID}}"
                            {{if eq (printf "%d" .Category.ID) $currentParentID}}selected{{end}}
                        >
                            {{if gt .Depth 0}}{{range seq 1 .Depth}}&nbsp;&nbsp;&nbsp;&nbsp;{{end}}{{end}}{{.Category.Name}}
                        </option>
                        {{end}}
                    {{end}}
                </select>
                {{if .Data.Errors.parent_id}}
                <span class="form-error">{{.Data.Errors.parent_id}}</span>
                {{else}}
                <span class="form-hint">Select a parent to create a subcategory</span>
                {{end}}
            </div>

            <!-- Position -->
            <div class="form-group">
                <label for="position" class="form-label">Position</label>
                <input
                    type="number"
                    id="position"
                    name="position"
                    class="form-input {{if .Data.Errors.position}}is-invalid{{end}}"
                    value="{{if .Data.FormValues.position}}{{.Data.FormValues.position}}{{else if .Data.Category}}{{.Data.Category.Position}}{{else}}0{{end}}"
                    min="0"
                    placeholder="0"
                >
                {{if .Data.Errors.position}}
                <span class="form-error">{{.Data.Errors.position}}</span>
                {{else}}
                <span class="form-hint">Lower numbers appear first in lists</span>
                {{end}}
            </div>

            <!-- Language -->
            {{if gt (len .Data.AllLanguages) 1}}
            <div class="form-group">
                <label for="language_id" class="form-label">Language</label>
                <select
                    id="language_id"
                    name="language_id"
                    class="form-select"
                    {{if .Data.IsEdit}}disabled{{end}}
                >
                    {{$currentLanguageID := int64 0}}
                    {{if .Data.FormValues.language_id}}
                        {{$currentLanguageID = atoi .Data.FormValues.language_id}}
                    {{else if .Data.Language}}
                        {{$currentLanguageID = .Data.Language.ID}}
                    {{else if .Data.Category}}
                        {{if .Data.Category.LanguageID.Valid}}
                            {{$currentLanguageID = .Data.Category.LanguageID.Int64}}
                        {{end}}
                    {{end}}
                    {{range .Data.AllLanguages}}
                    <option value="{{.ID}}" {{if eq .ID $currentLanguageID}}selected{{end}}>
                        {{.Name}} ({{.Code}})
                    </option>
                    {{end}}
                </select>
                {{if .Data.IsEdit}}
                <input type="hidden" name="language_id" value="{{if .Data.Language}}{{.Data.Language.ID}}{{end}}">
                <span class="form-hint">Language cannot be changed after creation. Use translations instead.</span>
                {{else}}
                <span class="form-hint">Select the language for this category</span>
                {{end}}
            </div>
            {{else if .Data.Language}}
            <input type="hidden" name="language_id" value="{{.Data.Language.ID}}">
            {{end}}
        </div>

        <!-- Translations Panel (Edit mode only) -->
        {{if and .Data.IsEdit (gt (len .Data.AllLanguages) 1)}}
        <div class="form-group form-group-full">
            <div class="translations-panel">
                <div class="translations-header">
                    <h3 class="translations-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg>
                        Translations
                    </h3>
                    {{if .Data.Language}}
                    <span class="current-language-badge">
                        Current: {{.Data.Language.Name}}
                    </span>
                    {{end}}
                </div>

                {{if .Data.Translations}}
                <div class="translations-list">
                    <h4 class="translations-subtitle">Existing Translations</h4>
                    {{range .Data.Translations}}
                    <div class="translation-item">
                        <div class="translation-info">
                            <span class="translation-lang-badge" title="{{.Language.NativeName}}">{{.Language.Code}}</span>
                            <a href="/admin/categories/{{.Category.ID}}" class="translation-link">
                                {{.Category.Name}}
                            </a>
                        </div>
                    </div>
                    {{end}}
                </div>
                {{end}}

                {{if .Data.MissingLanguages}}
                <div class="translations-add">
                    <h4 class="translations-subtitle">Add Translation</h4>
                    <div class="translation-buttons">
                        {{range .Data.MissingLanguages}}
                        <form action="/admin/categories/{{$.Data.Category.ID}}/translate/{{.Code}}" method="POST" class="inline-form">
                            <button type="submit" class="btn btn-sm btn-outline translation-add-btn" title="Create {{.Name}} translation">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                                {{.Code}} - {{.Name}}
                            </button>
                        </form>
                        {{end}}
                    </div>
                </div>
                {{end}}

                {{if and (not .Data.Translations) (not .Data.MissingLanguages)}}
                <p class="translations-empty">All available languages have translations.</p>
                {{end}}
            </div>
        </div>
        {{end}}

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                {{if .Data.IsEdit}}
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                Update Category
                {{else}}
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" x2="12" y1="11" y2="17"/><line x1="9" x2="15" y1="14" y2="14"/></svg>
                Create Category
                {{end}}
            </button>
            <a href="/admin/categories" class="btn btn-outline">Cancel</a>
        </div>
    </form>
</div>

<script>
function categoryForm() {
    return {
        slug: '{{if .Data.FormValues.slug}}{{.Data.FormValues.slug}}{{else if .Data.Category}}{{.Data.Category.Slug}}{{end}}',
        slugEdited: {{if .Data.IsEdit}}true{{else}}false{{end}},
        generateSlug(value) {
            if (!this.slugEdited) {
                this.slug = value
                    .toLowerCase()
                    .trim()
                    .replace(/[^\w\s-]/g, '')
                    .replace(/[\s_-]+/g, '-')
                    .replace(/^-+|-+$/g, '');
            }
        }
    }
}
</script>
{{end}}
