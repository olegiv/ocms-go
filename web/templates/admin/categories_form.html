{{define "content"}}
<div class="page-header">
    <div>
        <h1 class="page-title">{{if .Data.IsEdit}}{{T .AdminLang "categories.edit"}}{{else}}{{T .AdminLang "categories.new"}}{{end}}</h1>
        <p class="page-description">{{if .Data.IsEdit}}{{T .AdminLang "categories.edit_description"}}{{else}}{{T .AdminLang "categories.new_description"}}{{end}}</p>
    </div>
    <div class="page-actions">
        <a href="/admin/categories" class="btn btn-outline">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            {{T .AdminLang "categories.back_to_categories"}}
        </a>
    </div>
</div>

<div class="card">
    <form
        id="category-form"
        method="POST"
        action="{{if .Data.IsEdit}}/admin/categories/{{.Data.Category.ID}}{{else}}/admin/categories{{end}}"
        class="card-body"
        x-data="categoryForm()"
    >
        {{.CSRFField}}
        {{if .Data.IsEdit}}
        <input type="hidden" name="_method" value="PUT">
        {{end}}

        <div class="form-grid">
            <!-- Name -->
            <div class="form-group">
                <label for="name" class="form-label">
                    {{T .AdminLang "label.name"}} <span class="required">*</span>
                </label>
                <input
                    type="text"
                    id="name"
                    name="name"
                    class="form-input {{if .Data.Errors.name}}is-invalid{{end}}"
                    value="{{if .Data.FormValues.name}}{{.Data.FormValues.name}}{{else if .Data.Category}}{{.Data.Category.Name}}{{end}}"
                    placeholder="{{T .AdminLang "categories.name_placeholder"}}"
                    required
                    maxlength="255"
                    @input="generateSlug($event.target.value)"
                >
                {{if .Data.Errors.name}}
                <span class="form-error">{{.Data.Errors.name}}</span>
                {{else}}
                <span class="form-hint">{{T .AdminLang "categories.name_hint"}}</span>
                {{end}}
            </div>

            <!-- Slug -->
            <div class="form-group">
                <label for="slug" class="form-label">
                    {{T .AdminLang "label.slug"}} <span class="required">*</span>
                </label>
                <input
                    type="text"
                    id="slug"
                    name="slug"
                    class="form-input {{if .Data.Errors.slug}}is-invalid{{end}}"
                    value="{{if .Data.FormValues.slug}}{{.Data.FormValues.slug}}{{else if .Data.Category}}{{.Data.Category.Slug}}{{end}}"
                    placeholder="category-slug"
                    x-model="slug"
                    @input="slugEdited = true"
                    maxlength="255"
                >
                {{if .Data.Errors.slug}}
                <span class="form-error">{{.Data.Errors.slug}}</span>
                {{else}}
                <span class="form-hint">{{T .AdminLang "categories.slug_hint"}}</span>
                {{end}}
            </div>
        </div>

        <!-- Description -->
        <div class="form-group">
            <label for="description" class="form-label">{{T .AdminLang "categories.description_label"}}</label>
            <textarea
                id="description"
                name="description"
                class="form-input {{if .Data.Errors.description}}is-invalid{{end}}"
                rows="3"
                placeholder="{{T .AdminLang "categories.description_placeholder"}}"
            >{{if .Data.FormValues.description}}{{.Data.FormValues.description}}{{else if and .Data.Category .Data.Category.Description.Valid}}{{.Data.Category.Description.String}}{{end}}</textarea>
            {{if .Data.Errors.description}}
            <span class="form-error">{{.Data.Errors.description}}</span>
            {{else}}
            <span class="form-hint">{{T .AdminLang "categories.description_hint"}}</span>
            {{end}}
        </div>

        <div class="form-grid">
            <!-- Parent Category -->
            <div class="form-group">
                <label for="parent_id" class="form-label">{{T .AdminLang "categories.parent_category"}}</label>
                <select
                    id="parent_id"
                    name="parent_id"
                    class="form-input {{if .Data.Errors.parent_id}}is-invalid{{end}}"
                >
                    <option value="">{{T .AdminLang "categories.no_parent"}}</option>
                    {{$currentID := 0}}
                    {{if .Data.Category}}{{$currentID = .Data.Category.ID}}{{end}}
                    {{$currentParentID := ""}}
                    {{if .Data.FormValues.parent_id}}
                        {{$currentParentID = .Data.FormValues.parent_id}}
                    {{else if and .Data.Category .Data.Category.ParentID.Valid}}
                        {{$currentParentID = printf "%d" .Data.Category.ParentID.Int64}}
                    {{end}}
                    {{range .Data.AllCategories}}
                        {{if ne .Category.ID $currentID}}
                        <option
                            value="{{.Category.ID}}"
                            {{if eq (printf "%d" .Category.ID) $currentParentID}}selected{{end}}
                        >
                            {{if gt .Depth 0}}{{range seq 1 .Depth}}&nbsp;&nbsp;&nbsp;&nbsp;{{end}}{{end}}{{.Category.Name}}
                        </option>
                        {{end}}
                    {{end}}
                </select>
                {{if .Data.Errors.parent_id}}
                <span class="form-error">{{.Data.Errors.parent_id}}</span>
                {{else}}
                <span class="form-hint">{{T .AdminLang "categories.parent_hint"}}</span>
                {{end}}
            </div>

            <!-- Position -->
            <div class="form-group">
                <label for="position" class="form-label">{{T .AdminLang "label.position"}}</label>
                <input
                    type="number"
                    id="position"
                    name="position"
                    class="form-input {{if .Data.Errors.position}}is-invalid{{end}}"
                    value="{{if .Data.FormValues.position}}{{.Data.FormValues.position}}{{else if .Data.Category}}{{.Data.Category.Position}}{{else}}0{{end}}"
                    min="0"
                    placeholder="0"
                >
                {{if .Data.Errors.position}}
                <span class="form-error">{{.Data.Errors.position}}</span>
                {{else}}
                <span class="form-hint">{{T .AdminLang "categories.position_hint"}}</span>
                {{end}}
            </div>

            <!-- Language -->
            {{if gt (len .Data.AllLanguages) 1}}
            <div class="form-group">
                <label for="language_code" class="form-label">{{T .AdminLang "label.language"}}</label>
                <select
                    id="language_code"
                    name="language_code"
                    class="form-select"
                    {{if .Data.IsEdit}}disabled{{end}}
                >
                    {{$currentLanguageCode := ""}}
                    {{if .Data.FormValues.language_code}}
                        {{$currentLanguageCode = .Data.FormValues.language_code}}
                    {{else if .Data.Language}}
                        {{$currentLanguageCode = .Data.Language.Code}}
                    {{else if .Data.Category}}
                        {{$currentLanguageCode = .Data.Category.LanguageCode}}
                    {{end}}
                    {{range .Data.AllLanguages}}
                    <option value="{{.Code}}" {{if eq .Code $currentLanguageCode}}selected{{end}}>
                        {{.Name}} ({{.Code}})
                    </option>
                    {{end}}
                </select>
                {{if .Data.IsEdit}}
                <input type="hidden" name="language_code" value="{{if .Data.Language}}{{.Data.Language.Code}}{{end}}">
                <span class="form-hint">{{T .AdminLang "categories.language_readonly"}}</span>
                {{else}}
                <span class="form-hint">{{T .AdminLang "categories.select_language"}}</span>
                {{end}}
            </div>
            {{else if .Data.Language}}
            <input type="hidden" name="language_code" value="{{.Data.Language.Code}}">
            {{end}}
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                {{if .Data.IsEdit}}
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                {{T .AdminLang "categories.update"}}
                {{else}}
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" x2="12" y1="11" y2="17"/><line x1="9" x2="15" y1="14" y2="14"/></svg>
                {{T .AdminLang "categories.create"}}
                {{end}}
            </button>
            <a href="/admin/categories" class="btn btn-outline">{{T .AdminLang "btn.cancel"}}</a>
        </div>
    </form>

    <!-- Translations Panel (Edit mode only) - Outside main form to avoid nested forms -->
    {{if and .Data.IsEdit (gt (len .Data.AllLanguages) 1)}}
    <div class="translations-panel" style="margin-top: 1.5rem; padding: 1rem;">
        <div class="translations-header">
            <h3 class="translations-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg>
                {{T .AdminLang "categories.translations"}}
            </h3>
            {{if .Data.Language}}
            <span class="current-language-badge">
                {{T .AdminLang "categories.current_language"}}: {{.Data.Language.Name}}
            </span>
            {{end}}
        </div>

        {{if .Data.Translations}}
        <div class="translations-list">
            <h4 class="translations-subtitle">{{T .AdminLang "categories.existing_translations"}}</h4>
            {{range .Data.Translations}}
            <div class="translation-item">
                <div class="translation-info">
                    <span class="translation-lang-badge" title="{{.Language.NativeName}}">{{.Language.Code}}</span>
                    <a href="/admin/categories/{{.Category.ID}}" class="translation-link">
                        {{.Category.Name}}
                    </a>
                </div>
            </div>
            {{end}}
        </div>
        {{end}}

        {{if .Data.MissingLanguages}}
        <div class="translations-add">
            <h4 class="translations-subtitle">{{T .AdminLang "categories.add_translation"}}</h4>
            <div class="translation-buttons">
                {{range .Data.MissingLanguages}}
                <form action="/admin/categories/{{$.Data.Category.ID}}/translate/{{.Code}}" method="POST" class="inline-form">
                    {{$.CSRFField}}
                    <button type="submit" class="btn btn-sm btn-outline translation-add-btn" title="Create {{.Name}} translation">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                        {{.Code}} - {{.Name}}
                    </button>
                </form>
                {{end}}
            </div>
        </div>
        {{end}}

        {{if and (not .Data.Translations) (not .Data.MissingLanguages)}}
        <p class="translations-empty">{{T .AdminLang "categories.all_translations_exist"}}</p>
        {{end}}
    </div>
    {{end}}
</div>

<script>
function categoryForm() {
    return {
        slug: '{{if .Data.FormValues.slug}}{{.Data.FormValues.slug}}{{else if .Data.Category}}{{.Data.Category.Slug}}{{end}}',
        slugEdited: {{if .Data.IsEdit}}true{{else}}false{{end}},
        generateSlug(value) {
            if (!this.slugEdited) {
                this.slug = value
                    .toLowerCase()
                    .trim()
                    .replace(/[^\w\s-]/g, '')
                    .replace(/[\s_-]+/g, '-')
                    .replace(/^-+|-+$/g, '');
            }
        }
    }
}
</script>
{{end}}
