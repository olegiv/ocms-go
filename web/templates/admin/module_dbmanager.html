{{define "content"}}
<div class="page-header">
    <div>
        <h1 class="page-title">{{T .AdminLang "dbmanager.title"}}</h1>
        <p class="page-description">{{T .AdminLang "dbmanager.description"}}</p>
    </div>
    <div class="page-actions">
        <span class="badge badge-warning">{{T .AdminLang "dbmanager.warning_badge"}}</span>
    </div>
</div>

<div class="dbmanager-warning">
    <div class="card card-warning">
        <div class="card-body">
            <div class="warning-content">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
                    <path d="M12 9v4"/>
                    <path d="M12 17h.01"/>
                </svg>
                <div>
                    <strong>{{T .AdminLang "dbmanager.warning_title"}}</strong>
                    <p>{{T .AdminLang "dbmanager.warning_text"}}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="query-section">
    <div class="card">
        <div class="card-header">
            <h2>{{T .AdminLang "dbmanager.query_section"}}</h2>
        </div>
        <div class="card-body">
            <form method="POST" action="/admin/dbmanager/execute" id="query-form">
                {{.CSRFField}}
                <div class="form-group">
                    <textarea
                        name="query"
                        id="sql-query"
                        class="form-control form-control-code"
                        rows="8"
                        placeholder="{{T .AdminLang "dbmanager.query_placeholder"}}"
                        spellcheck="false"
                    >{{.Data.Query}}</textarea>
                    <small class="form-text text-muted">{{T .AdminLang "dbmanager.query_hint"}}</small>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="5 3 19 12 5 21 5 3"/>
                        </svg>
                        {{T .AdminLang "dbmanager.execute_button"}}
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('sql-query').value = ''">
                        {{T .AdminLang "dbmanager.clear_button"}}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{{if .Data.Result}}
<div class="results-section">
    <div class="card {{if .Data.Result.Error}}card-danger{{else}}card-success{{end}}">
        <div class="card-header">
            <h2>{{T .AdminLang "dbmanager.results_section"}}</h2>
            {{if not .Data.Result.Error}}
            <div class="result-stats">
                {{if .Data.Result.IsSelect}}
                <span class="badge badge-info">{{.Data.Result.RowsAffected}} {{T .AdminLang "dbmanager.results_rows"}}</span>
                {{else}}
                <span class="badge badge-info">{{.Data.Result.RowsAffected}} {{T .AdminLang "dbmanager.results_affected"}}</span>
                {{end}}
                <span class="badge badge-secondary">{{.Data.Result.ExecutionMs}} {{T .AdminLang "dbmanager.ms"}}</span>
            </div>
            {{end}}
        </div>
        <div class="card-body">
            {{if .Data.Result.Error}}
            <div class="alert alert-danger">
                <strong>{{T .AdminLang "dbmanager.error_title"}}:</strong> {{.Data.Result.Error}}
            </div>
            {{else if .Data.Result.IsSelect}}
                {{if .Data.Result.Columns}}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                {{range .Data.Result.Columns}}
                                <th>{{.}}</th>
                                {{end}}
                            </tr>
                        </thead>
                        <tbody>
                            {{if .Data.Result.Rows}}
                                {{range .Data.Result.Rows}}
                                <tr>
                                    {{range .}}
                                    <td>{{.}}</td>
                                    {{end}}
                                </tr>
                                {{end}}
                            {{else}}
                            <tr>
                                <td colspan="{{len .Data.Result.Columns}}" class="text-center text-muted">
                                    {{T $.AdminLang "dbmanager.results_empty"}}
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
                {{else}}
                <p class="text-muted">{{T .AdminLang "dbmanager.results_empty"}}</p>
                {{end}}
            {{else}}
            <div class="alert alert-success">
                {{T .AdminLang "dbmanager.results_success"}} - {{.Data.Result.RowsAffected}} {{T .AdminLang "dbmanager.results_affected"}}
            </div>
            {{end}}
        </div>
    </div>
</div>
{{end}}

{{if .Data.History}}
<div class="history-section">
    <div class="card">
        <div class="card-header">
            <h2>{{T .AdminLang "dbmanager.history_section"}}</h2>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>{{T .AdminLang "dbmanager.history_query"}}</th>
                            <th>{{T .AdminLang "dbmanager.history_time"}}</th>
                            <th>{{T .AdminLang "dbmanager.history_duration"}}</th>
                            <th>{{T .AdminLang "dbmanager.history_rows"}}</th>
                            <th>{{T .AdminLang "dbmanager.history_status"}}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .Data.History}}
                        <tr class="history-row" data-query="{{.Query}}">
                            <td class="query-cell">
                                <code class="query-preview">{{if gt (len .Query) 80}}{{slice .Query 0 80}}...{{else}}{{.Query}}{{end}}</code>
                            </td>
                            <td>{{.ExecutedAt.Format "2006-01-02 15:04:05"}}</td>
                            <td>{{.ExecutionTime}} {{T $.AdminLang "dbmanager.ms"}}</td>
                            <td>{{.RowsAffected}}</td>
                            <td>
                                {{if .Error.Valid}}
                                <span class="badge badge-danger" title="{{.Error.String}}">{{T $.AdminLang "dbmanager.history_failed"}}</span>
                                {{else}}
                                <span class="badge badge-success">{{T $.AdminLang "dbmanager.history_success"}}</span>
                                {{end}}
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{{else if not .Data.Result}}
<div class="history-section">
    <div class="card">
        <div class="card-header">
            <h2>{{T .AdminLang "dbmanager.history_section"}}</h2>
        </div>
        <div class="card-body">
            <p class="text-muted text-center">{{T .AdminLang "dbmanager.history_empty"}}</p>
        </div>
    </div>
</div>
{{end}}

<style>
.dbmanager-warning {
    margin-bottom: 1.5rem;
}

.warning-content {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.warning-content svg {
    flex-shrink: 0;
    color: var(--warning-color, #f0ad4e);
}

.warning-content p {
    margin: 0.25rem 0 0 0;
}

.query-section {
    margin-bottom: 1.5rem;
}

.form-control-code {
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', 'Droid Sans Mono', 'Source Code Pro', monospace;
    font-size: 0.875rem;
    line-height: 1.5;
    resize: vertical;
}

.form-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

.results-section {
    margin-bottom: 1.5rem;
}

.result-stats {
    display: flex;
    gap: 0.5rem;
}

.history-section {
    margin-bottom: 1.5rem;
}

.history-row {
    cursor: pointer;
}

.history-row:hover {
    background-color: var(--hover-bg, rgba(0,0,0,0.02));
}

.query-cell {
    max-width: 400px;
}

.query-preview {
    display: block;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 0.8125rem;
}

.card-success .card-header {
    background-color: rgba(40, 167, 69, 0.1);
    border-bottom-color: rgba(40, 167, 69, 0.2);
}

.card-danger .card-header {
    background-color: rgba(220, 53, 69, 0.1);
    border-bottom-color: rgba(220, 53, 69, 0.2);
}

.table-responsive {
    overflow-x: auto;
}

.table th {
    white-space: nowrap;
}

.table td {
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Click on history row to load query
    document.querySelectorAll('.history-row').forEach(function(row) {
        row.addEventListener('click', function() {
            var query = this.getAttribute('data-query');
            var textarea = document.getElementById('sql-query');
            if (textarea && query) {
                textarea.value = query;
                textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                textarea.focus();
            }
        });
    });

    // Keyboard shortcut: Ctrl+Enter to execute
    var textarea = document.getElementById('sql-query');
    if (textarea) {
        textarea.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('query-form').submit();
            }
        });
    }
});
</script>
{{end}}
