{{define "content"}}
<div class="page-header">
    <div>
        <h1 class="page-title">{{if .Data.IsEdit}}{{T .AdminLang "pages.edit"}}{{else}}{{T .AdminLang "pages.new"}}{{end}}</h1>
        <p class="page-description">{{if .Data.IsEdit}}{{T .AdminLang "pages.edit_description"}}{{else}}{{T .AdminLang "pages.new_description"}}{{end}}</p>
    </div>
    <div class="page-actions">
        {{if .Data.IsEdit}}
        <a href="/admin/pages/{{.Data.Page.ID}}/versions" class="btn btn-outline">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></svg>
            {{T .AdminLang "pages.version_history"}}
        </a>
        {{end}}
        <a href="/admin/pages" class="btn btn-outline">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            {{T .AdminLang "pages.back_to_pages"}}
        </a>
    </div>
</div>

<div class="card">
    <form
        method="POST"
        action="{{if .Data.IsEdit}}/admin/pages/{{.Data.Page.ID}}{{else}}/admin/pages{{end}}"
        class="card-body"
        x-data="pageForm()"
    >
        {{.CSRFField}}
        {{if .Data.IsEdit}}
        <input type="hidden" name="_method" value="PUT">
        {{end}}

        <div class="form-grid">
            <!-- Title -->
            <div class="form-group form-group-full">
                <label for="title" class="form-label">
                    {{T .AdminLang "label.title"}} <span class="required">*</span>
                </label>
                <input
                    type="text"
                    id="title"
                    name="title"
                    class="form-input {{if .Data.Errors.title}}is-invalid{{end}}"
                    value="{{if .Data.FormValues.title}}{{.Data.FormValues.title}}{{else if .Data.Page}}{{.Data.Page.Title}}{{end}}"
                    placeholder="{{T .AdminLang "hint.enter_page_title"}}"
                    required
                    @input="generateSlug($event.target.value)"
                >
                {{if .Data.Errors.title}}
                <span class="form-error">{{.Data.Errors.title}}</span>
                {{end}}
            </div>

            <!-- Slug -->
            <div class="form-group">
                <label for="slug" class="form-label">
                    {{T .AdminLang "label.slug"}} <span class="required">*</span>
                </label>
                <div class="input-with-prefix">
                    <span class="input-prefix">/</span>
                    <input
                        type="text"
                        id="slug"
                        name="slug"
                        class="form-input {{if .Data.Errors.slug}}is-invalid{{end}}"
                        value="{{if .Data.FormValues.slug}}{{.Data.FormValues.slug}}{{else if .Data.Page}}{{.Data.Page.Slug}}{{end}}"
                        placeholder="{{T .AdminLang "hint.page_slug"}}"
                        x-model="slug"
                        @input="slugEdited = true"
                    >
                </div>
                {{if .Data.Errors.slug}}
                <span class="form-error">{{.Data.Errors.slug}}</span>
                {{else}}
                <span class="form-hint">{{T .AdminLang "hint.slug"}}</span>
                {{end}}
            </div>

            <!-- Status -->
            <div class="form-group">
                <label for="status" class="form-label">{{T .AdminLang "label.status"}}</label>
                <select
                    id="status"
                    name="status"
                    class="form-select {{if .Data.Errors.status}}is-invalid{{end}}"
                >
                    {{$currentStatus := ""}}
                    {{if .Data.FormValues.status}}
                        {{$currentStatus = .Data.FormValues.status}}
                    {{else if .Data.Page}}
                        {{$currentStatus = .Data.Page.Status}}
                    {{else}}
                        {{$currentStatus = "draft"}}
                    {{end}}
                    {{range .Data.Statuses}}
                    <option value="{{.}}" {{if eq . $currentStatus}}selected{{end}}>
                        {{if eq . "draft"}}{{T $.AdminLang "status.draft"}}{{else if eq . "published"}}{{T $.AdminLang "status.published"}}{{else}}{{.}}{{end}}
                    </option>
                    {{end}}
                </select>
                {{if .Data.Errors.status}}
                <span class="form-error">{{.Data.Errors.status}}</span>
                {{end}}
            </div>

            <!-- Page Type -->
            <div class="form-group">
                <label for="page_type" class="form-label">{{T .AdminLang "pages.page_type"}}</label>
                <select
                    id="page_type"
                    name="page_type"
                    class="form-select {{if .Data.Errors.page_type}}is-invalid{{end}}"
                >
                    {{$currentPageType := "post"}}
                    {{if .Data.FormValues.page_type}}
                        {{$currentPageType = .Data.FormValues.page_type}}
                    {{else if .Data.Page}}
                        {{$currentPageType = .Data.Page.PageType}}
                    {{end}}
                    {{range .Data.PageTypes}}
                    <option value="{{.}}" {{if eq . $currentPageType}}selected{{end}}>
                        {{if eq . "post"}}{{T $.AdminLang "pages.type_post"}}{{else if eq . "page"}}{{T $.AdminLang "pages.type_page"}}{{else}}{{.}}{{end}}
                    </option>
                    {{end}}
                </select>
                {{if .Data.Errors.page_type}}
                <span class="form-error">{{.Data.Errors.page_type}}</span>
                {{else}}
                <span class="form-hint">{{T .AdminLang "pages.page_type_hint"}}</span>
                {{end}}
            </div>

            <!-- Language -->
            {{if gt (len .Data.AllLanguages) 1}}
            <div class="form-group">
                <label for="language_code" class="form-label">{{T .AdminLang "label.language"}}</label>
                <select
                    id="language_code"
                    name="language_code"
                    class="form-select"
                    {{if .Data.IsEdit}}disabled{{end}}
                >
                    {{$currentLanguageCode := ""}}
                    {{if .Data.FormValues.language_code}}
                        {{$currentLanguageCode = .Data.FormValues.language_code}}
                    {{else if .Data.Language}}
                        {{$currentLanguageCode = .Data.Language.Code}}
                    {{else if .Data.Page}}
                        {{$currentLanguageCode = .Data.Page.LanguageCode}}
                    {{end}}
                    {{range .Data.AllLanguages}}
                    <option value="{{.Code}}" {{if eq .Code $currentLanguageCode}}selected{{end}}>
                        {{.Name}} ({{.Code}})
                    </option>
                    {{end}}
                </select>
                {{if .Data.IsEdit}}
                <input type="hidden" name="language_code" value="{{if .Data.Language}}{{.Data.Language.Code}}{{end}}">
                <span class="form-hint">{{T .AdminLang "pages.language_readonly"}}</span>
                {{else}}
                <span class="form-hint">{{T .AdminLang "pages.select_language"}}</span>
                {{end}}
            </div>
            {{else if .Data.Language}}
            <input type="hidden" name="language_code" value="{{.Data.Language.Code}}">
            {{end}}

            <!-- Translations Panel (Edit mode only) -->
            {{if and .Data.IsEdit (gt (len .Data.AllLanguages) 1)}}
            <div class="form-group form-group-full">
                <div class="translations-panel">
                    <div class="translations-header">
                        <h3 class="translations-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg>
                            {{T .AdminLang "pages.translations"}}
                        </h3>
                        {{if .Data.Language}}
                        <span class="current-language-badge">
                            {{T .AdminLang "pages.current_language"}}: {{.Data.Language.Name}}
                        </span>
                        {{end}}
                    </div>

                    {{if .Data.Translations}}
                    <div class="translations-list">
                        <h4 class="translations-subtitle">{{T .AdminLang "pages.existing_translations"}}</h4>
                        {{range .Data.Translations}}
                        <div class="translation-item">
                            <div class="translation-info">
                                <span class="translation-lang-badge" title="{{.Language.NativeName}}">{{.Language.Code}}</span>
                                <a href="/admin/pages/{{.Page.ID}}" class="translation-link">
                                    {{.Page.Title}}
                                </a>
                                <span class="translation-status badge badge-{{if eq .Page.Status "published"}}success{{else}}warning{{end}}">
                                    {{if eq .Page.Status "published"}}{{T $.AdminLang "status.published"}}{{else if eq .Page.Status "draft"}}{{T $.AdminLang "status.draft"}}{{else}}{{.Page.Status}}{{end}}
                                </span>
                            </div>
                            <a href="/admin/pages/{{.Page.ID}}" class="btn btn-sm btn-outline">
                                {{T $.AdminLang "btn.edit"}}
                            </a>
                        </div>
                        {{end}}
                    </div>
                    {{end}}

                    {{if .Data.MissingLanguages}}
                    <div class="translations-add">
                        <h4 class="translations-subtitle">{{T .AdminLang "pages.add_translation"}}</h4>
                        <div class="translation-buttons">
                            {{range .Data.MissingLanguages}}
                            <button type="button" class="btn btn-sm btn-outline translation-add-btn" title="{{.Name}}" onclick="createTranslation('{{$.Data.Page.ID}}', '{{.Code}}')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                                {{.Code}} - {{.Name}}
                            </button>
                            {{end}}
                        </div>
                    </div>
                    {{end}}

                    {{if and (not .Data.Translations) (not .Data.MissingLanguages)}}
                    <p class="translations-empty">{{T .AdminLang "pages.all_translations_exist"}}</p>
                    {{end}}
                </div>
            </div>
            {{end}}

            <!-- Body (TinyMCE Editor) -->
            <div class="form-group form-group-full">
                <label class="form-label">{{T .AdminLang "label.content"}}</label>
                <div class="editor-container">
                    <textarea id="editor" name="body" class="tinymce-editor">{{if .Data.FormValues.body}}{{.Data.FormValues.body}}{{else if .Data.Page}}{{.Data.Page.Body}}{{end}}</textarea>
                </div>

                <!-- Editor Image Picker Modal -->
                <div id="editor-image-modal" class="editor-image-modal" style="display: none;">
                    <div class="editor-image-modal-overlay"></div>
                    <div class="editor-image-modal-dialog">
                        <div class="editor-image-modal-header">
                            <h3>{{T .AdminLang "editor.insert_image"}}</h3>
                            <button type="button" class="editor-image-modal-close" id="editor-image-close-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                            </button>
                        </div>

                        <!-- Search -->
                        <div class="editor-image-modal-toolbar">
                            <input type="text" id="editor-image-search" placeholder="{{T .AdminLang "media.search_media"}}" class="form-input">
                        </div>

                        <!-- Media Grid -->
                        <div class="editor-image-modal-content" id="editor-image-grid">
                            <!-- Populated via JavaScript -->
                        </div>

                        <!-- Image Options (shown after selection) -->
                        <div id="editor-image-options" class="editor-image-options" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">{{T .AdminLang "editor.alt_text"}} <span class="required">*</span></label>
                                <input type="text" id="editor-image-alt" class="form-input" placeholder="{{T .AdminLang "media.alt_placeholder"}}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">{{T .AdminLang "editor.image_size"}}</label>
                                <select id="editor-image-size" class="form-select">
                                    <option value="full">{{T .AdminLang "editor.size_full"}}</option>
                                    <option value="medium" selected>{{T .AdminLang "editor.size_medium"}}</option>
                                    <option value="small">{{T .AdminLang "editor.size_small"}}</option>
                                </select>
                            </div>
                        </div>

                        <!-- Footer Actions -->
                        <div class="editor-image-modal-footer">
                            <button type="button" class="btn btn-outline" id="editor-image-cancel-btn">{{T .AdminLang "btn.cancel"}}</button>
                            <button type="button" class="btn btn-primary" id="editor-image-insert-btn" disabled>{{T .AdminLang "editor.insert_image"}}</button>
                        </div>
                    </div>
                </div>

                {{if .Data.Errors.body}}
                <span class="form-error">{{.Data.Errors.body}}</span>
                {{end}}
            </div>

            <!-- Featured Image -->
            <div class="form-group form-group-full">
                {{if .Data.FeaturedImage}}
                {{template "media_dropzone" dict
                    "Mode" "select"
                    "Lang" .AdminLang
                    "Label" (T .AdminLang "media.featured_image")
                    "Hint" (T .AdminLang "media.featured_image_requirements")
                    "InputName" "featured_image_id"
                    "InitialImage" (printf `{"id":%d,"filename":"%s","filepath":"%s","thumbnail":"%s","mimetype":"%s"}` .Data.FeaturedImage.ID .Data.FeaturedImage.Filename .Data.FeaturedImage.Filepath .Data.FeaturedImage.Thumbnail .Data.FeaturedImage.Mimetype)
                }}
                {{else}}
                {{template "media_dropzone" dict
                    "Mode" "select"
                    "Lang" .AdminLang
                    "Label" (T .AdminLang "media.featured_image")
                    "Hint" (T .AdminLang "media.featured_image_requirements")
                    "InputName" "featured_image_id"
                }}
                {{end}}
            </div>

            <!-- Hide Featured Image Option -->
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="hide_featured_image" value="1"
                        {{if eq .Data.FormValues.hide_featured_image "1"}}checked{{else if and .Data.Page (eq .Data.Page.HideFeaturedImage 1)}}checked{{end}}>
                    <span>{{T .AdminLang "pages.hide_featured_image"}}</span>
                </label>
                <span class="form-hint">{{T .AdminLang "pages.hide_featured_image_hint"}}</span>
            </div>

            <!-- Exclude from Lists -->
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="exclude_from_lists" value="1"
                        {{if eq .Data.FormValues.exclude_from_lists "1"}}checked{{else if and .Data.Page (eq .Data.Page.ExcludeFromLists 1)}}checked{{end}}>
                    <span>{{T .AdminLang "pages.exclude_from_lists"}}</span>
                </label>
                <span class="form-hint">{{T .AdminLang "pages.exclude_from_lists_hint"}}</span>
            </div>

            <!-- Tags -->
            <div class="form-group form-group-full">
                {{template "tag_selector" .}}
            </div>

            <!-- Categories -->
            <div class="form-group form-group-full">
                {{template "category_selector" .}}
            </div>

            <!-- URL Aliases Section -->
            <div class="form-group form-group-full">
                <details class="collapsible-section" x-data="aliasManager()" :open="aliases.length > 0">
                    <summary class="collapsible-header" @click.prevent="$el.parentElement.open = !$el.parentElement.open">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
                        <span>{{T .AdminLang "pages.aliases"}}</span>
                        <template x-if="aliases.length > 0">
                            <span class="badge badge-info ml-2" x-text="aliases.length"></span>
                        </template>
                    </summary>
                    <div class="collapsible-content">
                        <!-- Existing Aliases List -->
                        <div class="aliases-list" x-show="aliases.length > 0">
                            <template x-for="(alias, index) in aliases" :key="index">
                                <div class="alias-item">
                                    <div class="input-with-prefix" style="flex: 1;">
                                        <span class="input-prefix">/</span>
                                        <input
                                            type="text"
                                            class="form-input"
                                            x-model="alias.value"
                                            name="aliases[]"
                                            placeholder="{{T .AdminLang "pages.alias_placeholder"}}"
                                            @input="validateAlias(index)"
                                        >
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline btn-danger" @click="removeAlias(index)" title="{{T .AdminLang "btn.remove"}}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                                    </button>
                                </div>
                            </template>
                        </div>

                        <!-- Add New Alias Button -->
                        <button type="button" class="btn btn-sm btn-outline mt-2" @click="addAlias()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                            {{T .AdminLang "pages.add_alias"}}
                        </button>

                        {{if .Data.Errors.aliases}}
                        <span class="form-error mt-2">{{.Data.Errors.aliases}}</span>
                        {{end}}

                        <span class="form-hint mt-2">{{T .AdminLang "pages.aliases_hint"}}</span>
                    </div>
                </details>
            </div>

            <!-- SEO Settings Section -->
            <div class="form-group form-group-full">
                <details class="collapsible-section" x-data="{ open: {{if or .Data.FormValues.meta_title .Data.FormValues.meta_description (and .Data.Page .Data.Page.MetaTitle) (and .Data.Page .Data.Page.MetaDescription)}}true{{else}}false{{end}} }" :open="open">
                    <summary class="collapsible-header" @click.prevent="open = !open">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
                        <span>{{T .AdminLang "seo.title"}}</span>
                    </summary>
                    <div class="collapsible-content">
                        <!-- Meta Title -->
                        <div class="form-group" x-data="{ charCount: 0 }" x-init="charCount = $refs.metaTitleInput.value.length">
                            <label for="meta_title" class="form-label">{{T .AdminLang "seo.meta_title"}}</label>
                            <input
                                type="text"
                                id="meta_title"
                                name="meta_title"
                                class="form-input"
                                x-ref="metaTitleInput"
                                value="{{if .Data.FormValues.meta_title}}{{.Data.FormValues.meta_title}}{{else if .Data.Page}}{{.Data.Page.MetaTitle}}{{end}}"
                                placeholder="{{T .AdminLang "seo.meta_title_hint"}}"
                                maxlength="70"
                                @input="charCount = $event.target.value.length"
                            >
                            <span class="form-hint">
                                <span x-text="charCount"></span>/60 {{T .AdminLang "seo.chars_recommended"}}
                                <span x-show="charCount > 60" class="text-warning"> - {{T .AdminLang "seo.may_be_truncated"}}</span>
                            </span>
                        </div>

                        <!-- Meta Description -->
                        <div class="form-group" x-data="{ charCount: 0 }" x-init="charCount = $refs.metaDescInput.value.length">
                            <label for="meta_description" class="form-label">{{T .AdminLang "seo.meta_description"}}</label>
                            <textarea
                                id="meta_description"
                                name="meta_description"
                                class="form-input form-textarea"
                                rows="3"
                                x-ref="metaDescInput"
                                placeholder="{{T .AdminLang "seo.meta_description_hint"}}"
                                maxlength="320"
                                @input="charCount = $event.target.value.length"
                            >{{if .Data.FormValues.meta_description}}{{.Data.FormValues.meta_description}}{{else if .Data.Page}}{{.Data.Page.MetaDescription}}{{end}}</textarea>
                            <span class="form-hint">
                                <span x-text="charCount"></span>/160 {{T .AdminLang "seo.chars_recommended"}}
                                <span x-show="charCount > 160" class="text-warning"> - {{T .AdminLang "seo.may_be_truncated"}}</span>
                            </span>
                        </div>

                        <!-- Meta Keywords -->
                        <div class="form-group">
                            <label for="meta_keywords" class="form-label">{{T .AdminLang "seo.meta_keywords"}}</label>
                            <input
                                type="text"
                                id="meta_keywords"
                                name="meta_keywords"
                                class="form-input"
                                value="{{if .Data.FormValues.meta_keywords}}{{.Data.FormValues.meta_keywords}}{{else if .Data.Page}}{{.Data.Page.MetaKeywords}}{{end}}"
                                placeholder="keyword1, keyword2, keyword3"
                            >
                            <span class="form-hint">{{T .AdminLang "seo.meta_keywords_hint"}}</span>
                        </div>

                        <!-- OG Image -->
                        <div class="form-group">
                            <label class="form-label">{{T .AdminLang "seo.og_image"}}</label>
                            <div class="media-picker" x-data="ogImagePicker()">
                                <input type="hidden" name="og_image_id" :value="selectedId">
                                <div class="media-picker-preview" x-show="selectedId">
                                    <img :src="selectedPath" alt="OG Image Preview" class="media-preview-img">
                                    <button type="button" class="btn btn-sm btn-outline media-remove-btn" @click="clearSelection()">{{T .AdminLang "btn.remove"}}</button>
                                </div>
                                <button type="button" class="btn btn-outline" @click="openMediaModal()" x-show="!selectedId">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                                    {{T .AdminLang "seo.select_og_image"}}
                                </button>
                                <span class="form-hint">{{T .AdminLang "seo.og_image_hint"}}</span>
                            </div>
                        </div>

                        <!-- Canonical URL -->
                        <div class="form-group">
                            <label for="canonical_url" class="form-label">{{T .AdminLang "seo.canonical_url"}}</label>
                            <input
                                type="url"
                                id="canonical_url"
                                name="canonical_url"
                                class="form-input"
                                value="{{if .Data.FormValues.canonical_url}}{{.Data.FormValues.canonical_url}}{{else if .Data.Page}}{{.Data.Page.CanonicalUrl}}{{end}}"
                                placeholder="https://example.com/original-page"
                            >
                            <span class="form-hint">{{T .AdminLang "seo.canonical_url_hint"}}</span>
                        </div>

                        <!-- Robots Settings -->
                        <div class="form-group">
                            <label class="form-label">{{T .AdminLang "seo.directives"}}</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" name="no_index" value="1" {{if .Data.FormValues.no_index}}{{if eq .Data.FormValues.no_index "1"}}checked{{end}}{{else if .Data.Page}}{{if .Data.Page.NoIndex}}checked{{end}}{{end}}>
                                    <div class="checkbox-text">
                                        <span class="checkbox-title">{{T .AdminLang "seo.no_index"}}</span>
                                        <span class="checkbox-hint">{{T .AdminLang "seo.no_index_hint"}}</span>
                                    </div>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="no_follow" value="1" {{if .Data.FormValues.no_follow}}{{if eq .Data.FormValues.no_follow "1"}}checked{{end}}{{else if .Data.Page}}{{if .Data.Page.NoFollow}}checked{{end}}{{end}}>
                                    <div class="checkbox-text">
                                        <span class="checkbox-title">{{T .AdminLang "seo.no_follow"}}</span>
                                        <span class="checkbox-hint">{{T .AdminLang "seo.no_follow_hint"}}</span>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </details>
            </div>

            <!-- Scheduling Section -->
            <div class="form-group form-group-full">
                <details class="collapsible-section" x-data="{ open: {{if or .Data.FormValues.scheduled_at (and .Data.Page .Data.Page.ScheduledAt.Valid)}}true{{else}}false{{end}} }" :open="open">
                    <summary class="collapsible-header" @click.prevent="open = !open">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
                        <span>{{T .AdminLang "schedule.title"}}</span>
                        {{if and .Data.Page .Data.Page.ScheduledAt.Valid}}
                        <span class="badge badge-info ml-2">{{T .AdminLang "schedule.scheduled"}}</span>
                        {{end}}
                    </summary>
                    <div class="collapsible-content">
                        <div class="form-group">
                            <label for="scheduled_at" class="form-label">{{T .AdminLang "schedule.datetime"}}</label>
                            <input
                                type="datetime-local"
                                id="scheduled_at"
                                name="scheduled_at"
                                class="form-input"
                                value="{{if .Data.FormValues.scheduled_at}}{{.Data.FormValues.scheduled_at}}{{else if and .Data.Page .Data.Page.ScheduledAt.Valid}}{{.Data.Page.ScheduledAt.Time.Format "2006-01-02T15:04"}}{{end}}"
                            >
                            <span class="form-hint">
                                {{T .AdminLang "schedule.hint"}}
                                {{if and .Data.Page .Data.Page.ScheduledAt.Valid}}
                                <br><strong>{{T .AdminLang "schedule.currently_scheduled"}}:</strong> {{formatDateTimeLocale .Data.Page.ScheduledAt.Time $.AdminLang}}
                                {{end}}
                            </span>
                        </div>
                        <div class="alert alert-info mt-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                            <div>
                                <strong>{{T .AdminLang "schedule.how_it_works"}}:</strong>
                                <ul class="ml-4 mt-1">
                                    <li>{{T .AdminLang "schedule.step1"}}</li>
                                    <li>{{T .AdminLang "schedule.step2"}}</li>
                                    <li>{{T .AdminLang "schedule.step3"}}</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </details>
            </div>
        </div>

        <div class="form-actions">
            <a href="/admin/pages" class="btn btn-outline">{{T .AdminLang "btn.cancel"}}</a>
            <button type="submit" class="btn btn-primary">
                {{if .Data.IsEdit}}{{T .AdminLang "pages.update"}}{{else}}{{T .AdminLang "pages.create"}}{{end}}
            </button>
        </div>
    </form>
</div>

<!-- TinyMCE Editor Scripts -->
<script src="/static/dist/js/tinymce/tinymce.min.js"></script>
<script>
// Store TinyMCE editor instance
let tinymceEditor = null;

// Editor Image Picker for TinyMCE
const editorImagePicker = {
    modal: null,
    grid: null,
    searchInput: null,
    optionsPanel: null,
    insertBtn: null,
    altInput: null,
    sizeSelect: null,
    selectedImage: null,
    currentPage: 1,
    debounceTimer: null,
    insertCallback: null,

    init() {
        this.modal = document.getElementById('editor-image-modal');
        this.grid = document.getElementById('editor-image-grid');
        this.searchInput = document.getElementById('editor-image-search');
        this.optionsPanel = document.getElementById('editor-image-options');
        this.insertBtn = document.getElementById('editor-image-insert-btn');
        this.altInput = document.getElementById('editor-image-alt');
        this.sizeSelect = document.getElementById('editor-image-size');

        // Search input handler with debounce
        this.searchInput.addEventListener('input', () => {
            clearTimeout(this.debounceTimer);
            this.debounceTimer = setTimeout(() => {
                this.currentPage = 1;
                this.loadMedia();
            }, 300);
        });

        // Close handlers
        document.getElementById('editor-image-close-btn').addEventListener('click', () => this.close());
        document.getElementById('editor-image-cancel-btn').addEventListener('click', () => this.close());
        this.modal.querySelector('.editor-image-modal-overlay').addEventListener('click', () => this.close());

        // Insert handler
        this.insertBtn.addEventListener('click', () => this.insert());

        // Close on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.modal.style.display !== 'none') {
                this.close();
            }
        });
    },

    open(callback) {
        this.insertCallback = callback || null;
        this.selectedImage = null;
        this.optionsPanel.style.display = 'none';
        this.insertBtn.disabled = true;
        this.altInput.value = '';
        this.searchInput.value = '';
        this.currentPage = 1;
        this.modal.style.display = 'flex';
        this.loadMedia();
        this.searchInput.focus();
    },

    close() {
        this.modal.style.display = 'none';
        this.selectedImage = null;
        this.insertCallback = null;
    },

    async loadMedia() {
        const search = this.searchInput.value.trim();
        let url = `/admin/media/api?page=${this.currentPage}&limit=12&type=image`;
        if (search) {
            url += `&q=${encodeURIComponent(search)}`;
        }

        try {
            this.grid.innerHTML = '<div class="editor-image-loading"><div class="spinner"></div><span>Loading...</span></div>';

            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to load media');

            const data = await response.json();
            this.renderGrid(data.items || []);
        } catch (error) {
            console.error('Failed to load media:', error);
            this.grid.innerHTML = '<div class="editor-image-empty"><p>Error loading media</p></div>';
        }
    },

    renderGrid(items) {
        if (!items || items.length === 0) {
            this.grid.innerHTML = `
                <div class="editor-image-empty">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                    <p>No images found</p>
                    <a href="/admin/media/upload" class="btn btn-primary btn-sm" target="_blank">Upload Images</a>
                </div>
            `;
            return;
        }

        this.currentItems = items;
        const gridHTML = items.map(item => {
            const isSelected = this.selectedImage?.id === item.id;
            const thumbnailUrl = item.thumbnail || item.filepath;
            return `
                <div class="editor-image-item ${isSelected ? 'is-selected' : ''}" data-id="${item.id}">
                    <div class="editor-image-item-preview">
                        <img src="${thumbnailUrl}" alt="${item.filename || ''}">
                    </div>
                    <div class="editor-image-item-info">
                        <span class="editor-image-item-name">${item.filename || 'Untitled'}</span>
                    </div>
                    ${isSelected ? '<div class="editor-image-item-check"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>' : ''}
                </div>
            `;
        }).join('');

        this.grid.innerHTML = `<div class="editor-image-grid">${gridHTML}</div>`;

        // Add click handlers to items
        this.grid.querySelectorAll('.editor-image-item').forEach(item => {
            item.addEventListener('click', () => {
                const id = parseInt(item.dataset.id, 10);
                const selectedItem = this.currentItems.find(i => i.id === id);
                if (selectedItem) {
                    this.selectImage(selectedItem);
                }
            });
        });
    },

    selectImage(item) {
        this.selectedImage = item;
        this.optionsPanel.style.display = 'block';
        this.insertBtn.disabled = false;
        // Pre-fill alt text with filename (without extension)
        const filenameWithoutExt = (item.filename || 'image').replace(/\.[^/.]+$/, '');
        this.altInput.value = item.alt || filenameWithoutExt;
        // Re-render to show selection state
        this.loadMedia();
    },

    insert() {
        if (!this.selectedImage) return;

        const alt = this.altInput.value.trim() || this.selectedImage.filename || 'Image';
        const size = this.sizeSelect.value;

        // Determine which image URL to use based on size
        let imageUrl = this.selectedImage.filepath; // original by default
        if (size === 'medium' && this.selectedImage.filepath) {
            // Use medium variant if available
            imageUrl = this.selectedImage.filepath.replace('/originals/', '/medium/');
        } else if (size === 'small' && this.selectedImage.thumbnail) {
            // Use thumbnail
            imageUrl = this.selectedImage.thumbnail;
        }

        // Use callback if provided (for TinyMCE file_picker_callback)
        if (this.insertCallback) {
            this.insertCallback(imageUrl, { alt: alt, title: alt });
        } else if (tinymceEditor) {
            // Direct insert into TinyMCE
            tinymceEditor.insertContent(`<img src="${imageUrl}" alt="${alt}" title="${alt}" />`);
        }

        this.close();
    }
};

// Initialize TinyMCE
document.addEventListener('DOMContentLoaded', function() {
    // Initialize image picker
    editorImagePicker.init();

    tinymce.init({
        selector: '#editor',
        height: 400,
        menubar: true,
        promotion: false,
        branding: false,
        base_url: '/static/dist/js/tinymce',
        plugins: [
            'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
            'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
            'insertdatetime', 'media', 'table', 'help', 'wordcount', 'codesample'
        ],
        toolbar: 'undo redo | blocks | ' +
            'bold italic forecolor | alignleft aligncenter ' +
            'alignright alignjustify | bullist numlist outdent indent | ' +
            'link customimage media codesample | code | removeformat | help',
        content_style: `
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
                font-size: 16px;
                line-height: 1.6;
                padding: 1rem;
            }
            img {
                max-width: 100%;
                height: auto;
                border-radius: 8px;
            }
            pre {
                background-color: #1e1e1e;
                color: #d4d4d4;
                padding: 1rem;
                border-radius: 8px;
                overflow-x: auto;
            }
            blockquote {
                border-left: 3px solid #ccc;
                padding-left: 1rem;
                margin: 1rem 0;
                color: #666;
                font-style: italic;
            }
        `,
        link_default_target: '_blank',
        link_assume_external_targets: true,
        image_advtab: true,
        image_title: true,
        automatic_uploads: false,
        // Custom image button that opens our media library
        setup: function(editor) {
            tinymceEditor = editor;

            // Custom image button
            editor.ui.registry.addButton('customimage', {
                icon: 'image',
                tooltip: '{{T .AdminLang "editor.insert_image"}}',
                onAction: function() {
                    editorImagePicker.open();
                }
            });
        },
        // Use our custom file picker for images
        file_picker_types: 'image',
        file_picker_callback: function(callback, value, meta) {
            if (meta.filetype === 'image') {
                editorImagePicker.open(callback);
            }
        },
        init_instance_callback: function(editor) {
            // Ensure form submission gets the latest content
            const form = editor.getElement().closest('form');
            if (form) {
                form.addEventListener('submit', function() {
                    editor.save();
                });
            }
        }
    });
});
</script>

<script>

// Create translation via POST and redirect
function createTranslation(pageId, langCode) {
    fetch(`/admin/pages/${pageId}/translate/${langCode}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
    }).then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        } else if (response.ok) {
            window.location.reload();
        } else {
            alert('Failed to create translation');
        }
    }).catch(error => {
        console.error('Error creating translation:', error);
        alert('Failed to create translation');
    });
}

// Alpine.js page form component
function pageForm() {
    return {
        slug: '{{if .Data.FormValues.slug}}{{.Data.FormValues.slug}}{{else if .Data.Page}}{{.Data.Page.Slug}}{{end}}',
        slugEdited: {{if .Data.IsEdit}}true{{else}}false{{end}},

        generateSlug(title) {
            if (this.slugEdited) return;

            // Simple slugify function
            this.slug = title
                .toLowerCase()
                .trim()
                .replace(/[^\w\s-]/g, '')
                .replace(/[\s_-]+/g, '-')
                .replace(/^-+|-+$/g, '');
        }
    };
}

// Alias manager component for URL aliases
function aliasManager() {
    return {
        aliases: [],

        init() {
            // Initialize with existing aliases from server
            {{if .Data.Aliases}}
            const existingAliases = [
                {{range .Data.Aliases}}
                { value: '{{.Alias}}', id: {{.ID}} },
                {{end}}
            ];
            this.aliases = existingAliases;
            {{end}}
        },

        addAlias() {
            this.aliases.push({ value: '', id: null });
        },

        removeAlias(index) {
            this.aliases.splice(index, 1);
        },

        validateAlias(index) {
            // Client-side slugify
            let value = this.aliases[index].value;
            value = value.toLowerCase()
                .trim()
                .replace(/[^\w\s-]/g, '')
                .replace(/[\s_-]+/g, '-')
                .replace(/^-+|-+$/g, '');
            this.aliases[index].value = value;
        }
    };
}

// OG Image picker component
function ogImagePicker() {
    return {
        selectedId: '{{if .Data.FormValues.og_image_id}}{{.Data.FormValues.og_image_id}}{{else if .Data.Page}}{{if .Data.Page.OgImageID.Valid}}{{.Data.Page.OgImageID.Int64}}{{end}}{{end}}' || '',
        selectedPath: '',

        init() {
            // If there's an existing OG image, we need to fetch its path
            if (this.selectedId) {
                this.fetchImagePath(this.selectedId);
            }
        },

        async fetchImagePath(id) {
            try {
                const response = await fetch(`/admin/media/api?limit=1`);
                const data = await response.json();
                // Find the media item with this ID
                const mediaResponse = await fetch(`/admin/media/${id}`);
                // For simplicity, construct the path based on common pattern
                // In a real implementation, you'd fetch the specific media details
                this.selectedPath = '/uploads/originals/' + id + '/image.jpg';
            } catch (error) {
                console.error('Failed to fetch OG image:', error);
            }
        },

        openMediaModal() {
            // Use the existing media picker modal if available
            if (typeof window.openMediaPickerForOG === 'function') {
                window.openMediaPickerForOG(this);
            } else {
                // Fallback: simple prompt for now
                const mediaId = prompt('Enter media ID for OG image:');
                if (mediaId) {
                    this.selectedId = mediaId;
                    this.selectedPath = '/uploads/originals/' + mediaId + '/image.jpg';
                }
            }
        },

        selectMedia(id, path, filename) {
            this.selectedId = id;
            this.selectedPath = path;
        },

        clearSelection() {
            this.selectedId = '';
            this.selectedPath = '';
        }
    };
}
</script>
{{end}}
