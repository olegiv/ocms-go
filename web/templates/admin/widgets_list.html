{{define "content"}}
<div class="page-header">
    <div>
        <h1 class="page-title">Widgets</h1>
        <p class="page-description">Manage widgets for <strong>{{.Data.Theme.Name}}</strong> theme</p>
    </div>
</div>

{{if .Data.WidgetAreas}}
<div class="widgets-container" x-data="widgetsManager()">
    <div class="widgets-grid">
        {{range .Data.WidgetAreas}}
        <div class="widget-area card">
            <div class="widget-area-header">
                <h3 class="widget-area-title">{{.Area.Name}}</h3>
                {{if .Area.Description}}
                <p class="widget-area-description">{{.Area.Description}}</p>
                {{end}}
            </div>

            <div class="widget-area-content" data-area="{{.Area.ID}}">
                {{if .Widgets}}
                <div class="widgets-list">
                    {{range .Widgets}}
                    <div class="widget-item" data-widget-id="{{.ID}}" id="widget-{{.ID}}">
                        <div class="widget-item-header">
                            <span class="widget-handle">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>
                            </span>
                            <span class="widget-type">{{.WidgetType}}</span>
                            {{if .Title.Valid}}
                            <span class="widget-title">{{.Title.String}}</span>
                            {{end}}
                            <div class="widget-actions">
                                <button type="button" class="btn btn-sm btn-outline" @click="editWidget({{.ID}})" title="Edit">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                                </button>
                                <button type="button" class="btn btn-sm btn-danger" @click="deleteWidget({{.ID}})" title="Delete">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    {{end}}
                </div>
                {{else}}
                <div class="empty-area">
                    <p>No widgets in this area</p>
                </div>
                {{end}}

                <button type="button" class="btn btn-outline btn-sm add-widget-btn" @click="openAddWidget('{{.Area.ID}}')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>
                    Add Widget
                </button>
            </div>
        </div>
        {{end}}
    </div>

    <!-- Add Widget Modal -->
    <div class="modal-overlay" x-show="showAddModal" x-cloak @click.self="showAddModal = false">
        <div class="modal" @click.stop>
            <div class="modal-header">
                <h3 class="modal-title">Add Widget</h3>
                <button type="button" class="modal-close" @click="showAddModal = false">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="widget-type">Widget Type</label>
                    <select id="widget-type" class="form-input" x-model="newWidget.widget_type">
                        <option value="">Select a widget type...</option>
                        {{range $.Data.WidgetTypes}}
                        <option value="{{.ID}}">{{.Name}} - {{.Description}}</option>
                        {{end}}
                    </select>
                </div>
                <div class="form-group">
                    <label for="widget-title">Title (optional)</label>
                    <input type="text" id="widget-title" class="form-input" x-model="newWidget.title" placeholder="Widget title">
                </div>
                <div class="form-group" x-show="newWidget.widget_type === 'text'">
                    <label for="widget-content">Content</label>
                    <textarea id="widget-content" class="form-input" rows="5" x-model="newWidget.content" placeholder="HTML content..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" @click="showAddModal = false">Cancel</button>
                <button type="button" class="btn btn-primary" @click="addWidget()" :disabled="!newWidget.widget_type">Add Widget</button>
            </div>
        </div>
    </div>

    <!-- Edit Widget Modal -->
    <div class="modal-overlay" x-show="showEditModal" x-cloak @click.self="showEditModal = false">
        <div class="modal" @click.stop>
            <div class="modal-header">
                <h3 class="modal-title">Edit Widget</h3>
                <button type="button" class="modal-close" @click="showEditModal = false">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="edit-widget-type">Widget Type</label>
                    <select id="edit-widget-type" class="form-input" x-model="editingWidget.widget_type">
                        {{range $.Data.WidgetTypes}}
                        <option value="{{.ID}}">{{.Name}}</option>
                        {{end}}
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-widget-title">Title</label>
                    <input type="text" id="edit-widget-title" class="form-input" x-model="editingWidget.title" placeholder="Widget title">
                </div>
                <div class="form-group" x-show="editingWidget.widget_type === 'text'">
                    <label for="edit-widget-content">Content</label>
                    <textarea id="edit-widget-content" class="form-input" rows="5" x-model="editingWidget.content" placeholder="HTML content..."></textarea>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" x-model="editingWidget.is_active">
                        <span>Active</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" @click="showEditModal = false">Cancel</button>
                <button type="button" class="btn btn-primary" @click="updateWidget()">Save Changes</button>
            </div>
        </div>
    </div>
</div>
<script>
function widgetsManager() {
    return {
        showAddModal: false,
        showEditModal: false,
        selectedArea: '',
        newWidget: {
            widget_type: '',
            title: '',
            content: ''
        },
        editingWidget: {
            id: 0,
            widget_type: '',
            title: '',
            content: '',
            is_active: true
        },

        openAddWidget(areaId) {
            this.selectedArea = areaId;
            this.newWidget = { widget_type: '', title: '', content: '' };
            this.showAddModal = true;
        },

        async addWidget() {
            try {
                const response = await fetch('/admin/widgets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        theme: '{{.Data.Theme.Name}}',
                        area: this.selectedArea,
                        widget_type: this.newWidget.widget_type,
                        title: this.newWidget.title,
                        content: this.newWidget.content
                    })
                });
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error adding widget');
                }
            } catch (err) {
                console.error(err);
                alert('Error adding widget');
            }
        },

        async editWidget(id) {
            try {
                const response = await fetch(`/admin/widgets/${id}`);
                if (response.ok) {
                    const widget = await response.json();
                    this.editingWidget = {
                        id: widget.id,
                        widget_type: widget.widget_type,
                        title: widget.title?.String || '',
                        content: widget.content?.String || '',
                        is_active: widget.is_active === 1
                    };
                    this.showEditModal = true;
                }
            } catch (err) {
                console.error(err);
                alert('Error loading widget');
            }
        },

        async updateWidget() {
            try {
                const response = await fetch(`/admin/widgets/${this.editingWidget.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        widget_type: this.editingWidget.widget_type,
                        title: this.editingWidget.title,
                        content: this.editingWidget.content,
                        is_active: this.editingWidget.is_active
                    })
                });
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error updating widget');
                }
            } catch (err) {
                console.error(err);
                alert('Error updating widget');
            }
        },

        async deleteWidget(id) {
            if (!confirm('Are you sure you want to delete this widget?')) return;
            try {
                const response = await fetch(`/admin/widgets/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    document.getElementById(`widget-${id}`).remove();
                } else {
                    alert('Error deleting widget');
                }
            } catch (err) {
                console.error(err);
                alert('Error deleting widget');
            }
        }
    };
}
</script>
{{else}}
<div class="card">
    <div class="card-body">
        <p>No widget areas defined for the current theme.</p>
        <p>Widget areas are defined in the theme's <code>theme.json</code> file.</p>
    </div>
</div>
{{end}}
{{end}}
