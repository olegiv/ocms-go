{{define "content"}}
<div class="page-header">
    <div>
        <h1 class="page-title">{{if .Data.IsEdit}}{{T .AdminLang "menus.edit"}}{{else}}{{T .AdminLang "menus.new"}}{{end}}</h1>
        <p class="page-description">{{if .Data.IsEdit}}{{T .AdminLang "menus.edit_description"}}{{else}}{{T .AdminLang "menus.new_description"}}{{end}}</p>
    </div>
    <div class="page-actions">
        <a href="/admin/menus" class="btn btn-outline">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            {{T .AdminLang "menus.back_to_menus"}}
        </a>
    </div>
</div>

<!-- Menu Settings Card -->
<div class="card mb-4">
    <div class="card-header">
        <h3 class="card-title">{{T .AdminLang "menus.settings"}}</h3>
    </div>
    <form
        method="POST"
        action="{{if .Data.IsEdit}}/admin/menus/{{.Data.Menu.ID}}{{else}}/admin/menus{{end}}"
        class="card-body"
    >
        {{.CSRFField}}
        {{if .Data.IsEdit}}
        <input type="hidden" name="_method" value="PUT">
        {{end}}

        <div class="form-grid">
            <div class="form-group">
                <label for="name" class="form-label">
                    {{T .AdminLang "label.name"}} <span class="required">*</span>
                </label>
                <input
                    type="text"
                    id="name"
                    name="name"
                    class="form-input {{if .Data.Errors.name}}is-invalid{{end}}"
                    value="{{if .Data.FormValues.name}}{{.Data.FormValues.name}}{{else if .Data.Menu}}{{.Data.Menu.Name}}{{end}}"
                    placeholder="{{T .AdminLang "menus.name_placeholder"}}"
                    required
                >
                {{if .Data.Errors.name}}
                <span class="form-error">{{.Data.Errors.name}}</span>
                {{end}}
            </div>

            <div class="form-group">
                <label for="slug" class="form-label">
                    {{T .AdminLang "label.slug"}} <span class="required">*</span>
                </label>
                <input
                    type="text"
                    id="slug"
                    name="slug"
                    class="form-input {{if .Data.Errors.slug}}is-invalid{{end}}"
                    value="{{if .Data.FormValues.slug}}{{.Data.FormValues.slug}}{{else if .Data.Menu}}{{.Data.Menu.Slug}}{{end}}"
                    placeholder="{{T .AdminLang "menus.slug_placeholder"}}"
                >
                {{if .Data.Errors.slug}}
                <span class="form-error">{{.Data.Errors.slug}}</span>
                {{else}}
                <span class="form-hint">{{T .AdminLang "menus.slug_hint"}}</span>
                {{end}}
            </div>

            <div class="form-group">
                <label for="language_id" class="form-label">
                    {{T .AdminLang "label.language"}}
                </label>
                <select
                    id="language_id"
                    name="language_id"
                    class="form-select {{if .Data.Errors.language_id}}is-invalid{{end}}"
                >
                    {{$currentLangID := ""}}
                    {{if .Data.FormValues.language_id}}
                        {{$currentLangID = .Data.FormValues.language_id}}
                    {{else if and .Data.Menu .Data.Menu.LanguageID.Valid}}
                        {{$currentLangID = printf "%d" .Data.Menu.LanguageID.Int64}}
                    {{end}}
                    {{range .Data.Languages}}
                    <option value="{{.ID}}" {{if eq (printf "%d" .ID) $currentLangID}}selected{{end}}>
                        {{.NativeName}} ({{.Code}})
                    </option>
                    {{end}}
                </select>
                {{if .Data.Errors.language_id}}
                <span class="form-error">{{.Data.Errors.language_id}}</span>
                {{else}}
                <span class="form-hint">{{T .AdminLang "menus.language_hint"}}</span>
                {{end}}
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                {{if .Data.IsEdit}}{{T .AdminLang "menus.save_settings"}}{{else}}{{T .AdminLang "menus.create"}}{{end}}
            </button>
        </div>
    </form>
</div>

{{if .Data.IsEdit}}
<!-- Menu Builder -->
<div class="menu-builder" x-data="menuBuilder()">
    <div class="menu-builder-grid">
        <!-- Left Panel: Add Items -->
        <div class="menu-builder-panel">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">{{T .AdminLang "menus.add_items"}}</h3>
                </div>
                <div class="card-body">
                    <!-- Add Custom Link -->
                    <div class="menu-add-section">
                        <h4 class="menu-add-title">{{T .AdminLang "menus.custom_link"}}</h4>
                        <div class="form-group">
                            <label class="form-label">{{T .AdminLang "label.title"}}</label>
                            <input type="text" class="form-input" x-model="customLink.title" placeholder="{{T .AdminLang "menus.link_text"}}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">URL</label>
                            <input type="text" class="form-input" x-model="customLink.url" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">{{T .AdminLang "menus.target"}}</label>
                            <select class="form-select" x-model="customLink.target">
                                {{range .Data.Targets}}
                                <option value="{{.}}">{{.}}</option>
                                {{end}}
                            </select>
                        </div>
                        <button type="button" class="btn btn-primary btn-sm" @click="addCustomLink()" :disabled="!customLink.title || !customLink.url">
                            {{T .AdminLang "menus.add_to_menu"}}
                        </button>
                    </div>

                    <!-- Add Pages -->
                    {{if .Data.Pages}}
                    <div class="menu-add-section">
                        <h4 class="menu-add-title">{{T .AdminLang "pages.title"}}</h4>
                        <div class="menu-pages-list">
                            {{range .Data.Pages}}
                            <div class="menu-page-item">
                                <label class="checkbox-label">
                                    <input type="checkbox" :checked="isPageSelected({{.ID}})" @change="togglePage({{.ID}}, '{{.Title}}', '{{.Slug}}')">
                                    <span>{{.Title}}</span>
                                </label>
                            </div>
                            {{end}}
                        </div>
                        <button type="button" class="btn btn-primary btn-sm" @click="addSelectedPages()" :disabled="selectedPages.length === 0">
                            {{T .AdminLang "menus.add_selected"}}
                        </button>
                    </div>
                    {{end}}
                </div>
            </div>
        </div>

        <!-- Right Panel: Menu Structure -->
        <div class="menu-builder-panel menu-builder-main">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">{{T .AdminLang "menus.structure"}}</h3>
                    <span class="text-muted" x-show="hasChanges">{{T .AdminLang "menus.unsaved_changes"}}</span>
                </div>
                <div class="card-body">
                    <template x-if="items.length === 0">
                        <div class="menu-empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="3" x2="21" y1="6" y2="6"/><line x1="3" x2="21" y1="12" y2="12"/><line x1="3" x2="21" y1="18" y2="18"/></svg>
                            <p>{{T .AdminLang "menus.no_items"}}</p>
                        </div>
                    </template>

                    <div id="menu-items" class="menu-items-container">
                        <template x-for="(item, index) in items" :key="item.id || item.tempId">
                            <div class="menu-item" :data-id="item.id || item.tempId">
                                <div class="menu-item-header">
                                    <div class="menu-item-handle">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>
                                    </div>
                                    <div class="menu-item-info">
                                        <span class="menu-item-title" x-text="item.title"></span>
                                        <span class="menu-item-type" x-text="item.page_id ? '{{T .AdminLang "menus.item_page"}}' : '{{T .AdminLang "menus.item_custom"}}'"></span>
                                    </div>
                                    <div class="menu-item-actions">
                                        <button type="button" class="btn btn-sm btn-icon" @click="editItem(item)" title="{{T .AdminLang "btn.edit"}}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-icon btn-danger" @click="deleteItem(item, index)" title="{{T .AdminLang "btn.delete"}}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                        </button>
                                    </div>
                                </div>
                                <!-- Nested children -->
                                <div class="menu-item-children" x-show="item.children && item.children.length > 0">
                                    <template x-for="(child, childIndex) in item.children" :key="child.id || child.tempId">
                                        <div class="menu-item menu-item-nested" :data-id="child.id || child.tempId">
                                            <div class="menu-item-header">
                                                <div class="menu-item-handle">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>
                                                </div>
                                                <div class="menu-item-info">
                                                    <span class="menu-item-title" x-text="child.title"></span>
                                                    <span class="menu-item-type" x-text="child.page_id ? '{{T .AdminLang "menus.item_page"}}' : '{{T .AdminLang "menus.item_custom"}}'"></span>
                                                </div>
                                                <div class="menu-item-actions">
                                                    <button type="button" class="btn btn-sm btn-icon" @click="editItem(child)" title="{{T .AdminLang "btn.edit"}}">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-icon btn-danger" @click="deleteChildItem(item, childIndex)" title="{{T .AdminLang "btn.delete"}}">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>

                    <div class="menu-builder-actions" x-show="hasChanges">
                        <button type="button" class="btn btn-primary" @click="saveOrder()" :disabled="saving">
                            <span x-show="!saving">{{T .AdminLang "menus.save_order"}}</span>
                            <span x-show="saving">{{T .AdminLang "menus.saving"}}</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <template x-if="editingItem">
        <div class="modal-overlay" x-show="editingItem" x-cloak @click.self="editingItem = null">
            <div class="modal" @click.stop>
                <div class="modal-header">
                    <h3 class="modal-title">{{T .AdminLang "menus.edit_item"}}</h3>
                    <button type="button" class="modal-close" @click="editingItem = null" aria-label="{{T .AdminLang "btn.close"}}">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">{{T .AdminLang "label.title"}}</label>
                        <input type="text" class="form-input" x-model="editingItem.title">
                    </div>
                    <div class="form-group" x-show="!editingItem.page_id">
                        <label class="form-label">URL</label>
                        <input type="text" class="form-input" x-model="editingItem.url">
                    </div>
                    <div class="form-group">
                        <label class="form-label">{{T .AdminLang "menus.target"}}</label>
                        <select class="form-select" x-model="editingItem.target">
                            {{range .Data.Targets}}
                            <option value="{{.}}">{{.}}</option>
                            {{end}}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">{{T .AdminLang "menus.css_class"}}</label>
                        <input type="text" class="form-input" x-model="editingItem.css_class" placeholder="{{T .AdminLang "menus.css_class_placeholder"}}">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" x-model="editingItem.is_active">
                            <span>{{T .AdminLang "label.active"}}</span>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" @click="editingItem = null">{{T .AdminLang "btn.cancel"}}</button>
                    <button type="button" class="btn btn-primary" @click="saveItem()">{{T .AdminLang "btn.save_changes"}}</button>
                </div>
            </div>
        </div>
    </template>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="/static/dist/js/menu-builder.js"></script>
<script>
function menuBuilder() {
    return {
        // Template data
        menuId: {{.Data.Menu.ID}},
        items: [],
        customLink: { title: '', url: '', target: '_self' },
        selectedPages: [],
        editingItem: null,
        hasChanges: false,
        saving: false,
        tempIdCounter: 0,

        // i18n strings for confirmation dialogs
        i18n: {
            confirmDelete: '{{T .AdminLang "label.confirm_delete"}}'
        },

        init() {
            // Load existing items from server data
            this.items = this.parseItems({{toJSON .Data.Items}});

            // Initialize Sortable after DOM is ready
            this.$nextTick(() => {
                this.initSortable();
            });
        },

        // Spread external methods
        ...menuBuilderMethods
    };
}
</script>
{{end}}
{{end}}
