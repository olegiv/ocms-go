{{define "content"}}
<div class="page-header">
    <div>
        <h1 class="page-title">{{T .AdminLang "page_analytics.title"}}</h1>
        <p class="page-description">{{T .AdminLang "page_analytics.description"}}</p>
    </div>
    <div class="page-actions">
        <div class="date-range-selector">
            <a href="?range=7d" class="btn btn-sm {{if eq .Data.DateRange "7d"}}btn-primary{{else}}btn-outline{{end}}">7d</a>
            <a href="?range=30d" class="btn btn-sm {{if eq .Data.DateRange "30d"}}btn-primary{{else}}btn-outline{{end}}">30d</a>
            <a href="?range=90d" class="btn btn-sm {{if eq .Data.DateRange "90d"}}btn-primary{{else}}btn-outline{{end}}">90d</a>
            <a href="?range=1y" class="btn btn-sm {{if eq .Data.DateRange "1y"}}btn-primary{{else}}btn-outline{{end}}">1y</a>
        </div>
    </div>
</div>

<!-- Overview Stats -->
<div class="stats-section">
    <div class="stats-grid stats-grid-4">
        <div class="stat-card">
            <div class="stat-icon stat-icon-blue">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-value">{{.Data.Overview.TotalViews}}</span>
                <span class="stat-label">{{T .AdminLang "page_analytics.total_views"}}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon stat-icon-green">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-value">{{.Data.Overview.UniqueVisitors}}</span>
                <span class="stat-label">{{T .AdminLang "page_analytics.unique_visitors"}}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon stat-icon-orange">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-value">{{printf "%.1f" .Data.Overview.BounceRate}}%</span>
                <span class="stat-label">{{T .AdminLang "page_analytics.bounce_rate"}}</span>
            </div>
        </div>
        <div class="stat-card stat-card-realtime">
            <div class="stat-icon stat-icon-purple">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-value" id="realtime-count">{{.Data.Overview.RealTimeVisitors}}</span>
                <span class="stat-label">{{T .AdminLang "page_analytics.realtime"}}</span>
            </div>
            <span class="realtime-dot"></span>
        </div>
    </div>
</div>

<!-- Today's Stats -->
<div class="today-stats">
    <div class="today-card">
        <span class="today-label">{{T .AdminLang "page_analytics.today"}}</span>
        <span class="today-value">{{.Data.Overview.ViewsToday}}</span>
        {{if ne .Data.Overview.ViewsYesterday 0}}
        <span class="today-trend {{if gt .Data.Overview.TrendPercent 0}}trend-up{{else if lt .Data.Overview.TrendPercent 0}}trend-down{{else}}trend-neutral{{end}}">
            {{if gt .Data.Overview.TrendPercent 0}}+{{end}}{{printf "%.1f" .Data.Overview.TrendPercent}}%
        </span>
        {{end}}
    </div>
</div>

<!-- Main Dashboard Grid -->
<div class="analytics-grid">
    <!-- Time Series Chart -->
    <div class="card chart-card">
        <div class="card-header">
            <h3>{{T .AdminLang "page_analytics.views_over_time"}}</h3>
        </div>
        <div class="card-body">
            {{if .Data.TimeSeries}}
            <div class="chart-container">
                <div class="bar-chart" id="views-chart">
                    {{range .Data.TimeSeries}}
                    <div class="bar-group" data-views="{{.Views}}" title="{{.Date}}: {{.Views}} views">
                        <div class="bar"></div>
                        <span class="bar-label">{{slice .Date 5 10}}</span>
                    </div>
                    {{end}}
                </div>
            </div>
            <script>
            (function() {
                const chart = document.getElementById('views-chart');
                if (!chart) return;
                const bars = chart.querySelectorAll('.bar-group');
                let maxViews = 1;
                bars.forEach(b => {
                    const v = parseInt(b.dataset.views) || 0;
                    if (v > maxViews) maxViews = v;
                });
                bars.forEach(b => {
                    const v = parseInt(b.dataset.views) || 0;
                    const pct = Math.round((v / maxViews) * 100);
                    b.querySelector('.bar').style.height = pct + '%';
                });
            })();
            </script>
            {{else}}
            <div class="empty-state">
                <p>{{T .AdminLang "page_analytics.no_data"}}</p>
            </div>
            {{end}}
        </div>
    </div>

    <!-- Top Pages -->
    <div class="card">
        <div class="card-header">
            <h3>{{T .AdminLang "page_analytics.top_pages"}}</h3>
        </div>
        <div class="card-body">
            {{if .Data.TopPages}}
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>{{T .AdminLang "page_analytics.page"}}</th>
                        <th class="text-right">{{T .AdminLang "page_analytics.views"}}</th>
                        <th class="text-right">{{T .AdminLang "page_analytics.visitors"}}</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Data.TopPages}}
                    <tr>
                        <td class="page-path" title="{{.Path}}">{{.PageTitle}}</td>
                        <td class="text-right">{{.Views}}</td>
                        <td class="text-right">{{.UniqueVisitors}}</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
            {{else}}
            <div class="empty-state">
                <p>{{T .AdminLang "page_analytics.no_data"}}</p>
            </div>
            {{end}}
        </div>
    </div>

    <!-- Top Referrers -->
    <div class="card">
        <div class="card-header">
            <h3>{{T .AdminLang "page_analytics.top_referrers"}}</h3>
        </div>
        <div class="card-body">
            {{if .Data.TopReferrers}}
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>{{T .AdminLang "page_analytics.source"}}</th>
                        <th class="text-right">{{T .AdminLang "page_analytics.views"}}</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Data.TopReferrers}}
                    <tr>
                        <td class="referrer-domain">{{if .Domain}}{{.Domain}}{{else}}(direct){{end}}</td>
                        <td class="text-right">{{.Views}}</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
            {{else}}
            <div class="empty-state">
                <p>{{T .AdminLang "page_analytics.no_referrer_data"}}</p>
            </div>
            {{end}}
        </div>
    </div>

    <!-- Browsers -->
    <div class="card">
        <div class="card-header">
            <h3>{{T .AdminLang "page_analytics.browsers"}}</h3>
        </div>
        <div class="card-body">
            {{if .Data.Browsers}}
            <div class="breakdown-list">
                {{range .Data.Browsers}}
                <div class="breakdown-item">
                    <div class="breakdown-info">
                        <span class="breakdown-name">{{.Browser}}</span>
                        <span class="breakdown-value">{{printf "%.1f" .Percent}}%</span>
                    </div>
                    <div class="breakdown-bar">
                        <div class="breakdown-fill" style="width: {{printf "%.0f" .Percent}}%"></div>
                    </div>
                </div>
                {{end}}
            </div>
            {{else}}
            <div class="empty-state">
                <p>{{T .AdminLang "page_analytics.no_data"}}</p>
            </div>
            {{end}}
        </div>
    </div>

    <!-- Devices -->
    <div class="card">
        <div class="card-header">
            <h3>{{T .AdminLang "page_analytics.devices"}}</h3>
        </div>
        <div class="card-body">
            {{if .Data.Devices}}
            <div class="device-breakdown">
                {{range .Data.Devices}}
                <div class="device-item">
                    <div class="device-icon device-icon-{{.DeviceType}}">
                        {{if eq .DeviceType "desktop"}}
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect width="20" height="14" x="2" y="3" rx="2"/>
                            <line x1="8" x2="16" y1="21" y2="21"/>
                            <line x1="12" x2="12" y1="17" y2="21"/>
                        </svg>
                        {{else if eq .DeviceType "mobile"}}
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect width="14" height="20" x="5" y="2" rx="2" ry="2"/>
                            <path d="M12 18h.01"/>
                        </svg>
                        {{else if eq .DeviceType "tablet"}}
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect width="16" height="20" x="4" y="2" rx="2" ry="2"/>
                            <line x1="12" x2="12.01" y1="18" y2="18"/>
                        </svg>
                        {{else}}
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 16v-4"/>
                            <path d="M12 8h.01"/>
                        </svg>
                        {{end}}
                    </div>
                    <div class="device-info">
                        <span class="device-type">{{.DeviceType}}</span>
                        <span class="device-percent">{{printf "%.1f" .Percent}}%</span>
                    </div>
                </div>
                {{end}}
            </div>
            {{else}}
            <div class="empty-state">
                <p>{{T .AdminLang "page_analytics.no_data"}}</p>
            </div>
            {{end}}
        </div>
    </div>

    <!-- Countries -->
    <div class="card">
        <div class="card-header">
            <h3>{{T .AdminLang "page_analytics.countries"}}</h3>
        </div>
        <div class="card-body">
            {{if .Data.Countries}}
            <div class="breakdown-list">
                {{range .Data.Countries}}
                <div class="breakdown-item">
                    <div class="breakdown-info">
                        <span class="breakdown-name">{{.CountryName}}</span>
                        <span class="breakdown-value">{{printf "%.1f" .Percent}}%</span>
                    </div>
                    <div class="breakdown-bar">
                        <div class="breakdown-fill breakdown-fill-geo" style="width: {{printf "%.0f" .Percent}}%"></div>
                    </div>
                </div>
                {{end}}
            </div>
            {{else}}
            <div class="empty-state">
                <p>{{T .AdminLang "page_analytics.no_geo_data"}}</p>
            </div>
            {{end}}
        </div>
    </div>
</div>

<!-- Settings -->
<div class="settings-section">
    <div class="card">
        <div class="card-header">
            <h3>{{T .AdminLang "page_analytics.settings"}}</h3>
        </div>
        <div class="card-body">
            <form method="POST" action="/admin/page-analytics/settings">
                {{.CSRFField}}
                <div class="form-group">
                    <label class="form-check">
                        <input type="checkbox" name="enabled" value="1" {{if .Data.Settings.Enabled}}checked{{end}}>
                        <span>{{T .AdminLang "page_analytics.enabled"}}</span>
                    </label>
                    <p class="form-hint">{{T .AdminLang "page_analytics.enabled_hint"}}</p>
                </div>
                <div class="form-group">
                    <label>{{T .AdminLang "page_analytics.retention_days"}}</label>
                    <input type="number" name="retention_days" value="{{.Data.Settings.RetentionDays}}" min="30" max="730" class="form-control form-control-sm">
                    <p class="form-hint">{{T .AdminLang "page_analytics.retention_hint"}}</p>
                </div>
                <div class="form-group">
                    <label>{{T .AdminLang "page_analytics.exclude_paths"}}</label>
                    <textarea name="exclude_paths" rows="3" class="form-control" placeholder="/private&#10;/internal">{{range .Data.Settings.ExcludePaths}}{{.}}
{{end}}</textarea>
                    <p class="form-hint">{{T .AdminLang "page_analytics.exclude_hint"}}</p>
                </div>
                <button type="submit" class="btn btn-primary">{{T .AdminLang "page_analytics.save_settings"}}</button>
            </form>
        </div>
    </div>
</div>

<style>
.date-range-selector {
    display: flex;
    gap: 0.5rem;
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-primary);
}

.btn-outline:hover {
    background: var(--bg-secondary);
}

.stats-grid-4 {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 1.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    position: relative;
}

.stat-card-realtime {
    border-color: var(--primary-color);
}

.realtime-dot {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    width: 8px;
    height: 8px;
    background: #22c55e;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.stat-icon-blue { background: #e3f2fd; color: #1976d2; }
.stat-icon-green { background: #e8f5e9; color: #388e3c; }
.stat-icon-orange { background: #fff3e0; color: #f57c00; }
.stat-icon-purple { background: #f3e5f5; color: #7b1fa2; }

.stat-content {
    display: flex;
    flex-direction: column;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 1;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
}

.today-stats {
    margin-bottom: 1.5rem;
}

.today-card {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 0.75rem 1.25rem;
}

.today-label {
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.today-value {
    font-weight: 600;
    font-size: 1.125rem;
}

.today-trend {
    font-size: 0.875rem;
    padding: 0.125rem 0.5rem;
    border-radius: var(--radius-sm);
}

.trend-up { background: #dcfce7; color: #166534; }
.trend-down { background: #fee2e2; color: #991b1b; }
.trend-neutral { background: var(--bg-secondary); color: var(--text-secondary); }

.analytics-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.chart-card {
    grid-column: span 2;
}

.chart-container {
    height: 200px;
    overflow-x: auto;
}

.bar-chart {
    display: flex;
    align-items: flex-end;
    height: 100%;
    gap: 4px;
    min-width: max-content;
    padding: 0 0.5rem;
}

.bar-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    min-width: 20px;
    max-width: 40px;
}

.bar {
    width: 100%;
    background: var(--primary-color);
    border-radius: 4px 4px 0 0;
    min-height: 2px;
    transition: height 0.3s ease;
}

.bar-label {
    font-size: 0.625rem;
    color: var(--text-secondary);
    margin-top: 4px;
    white-space: nowrap;
}

.table-sm th,
.table-sm td {
    padding: 0.5rem;
    font-size: 0.875rem;
}

.page-path {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.text-right {
    text-align: right;
}

.breakdown-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.breakdown-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.breakdown-info {
    display: flex;
    justify-content: space-between;
    font-size: 0.875rem;
}

.breakdown-name {
    color: var(--text-primary);
}

.breakdown-value {
    color: var(--text-secondary);
}

.breakdown-bar {
    height: 6px;
    background: var(--bg-secondary);
    border-radius: 3px;
    overflow: hidden;
}

.breakdown-fill {
    height: 100%;
    background: var(--primary-color);
    border-radius: 3px;
}

.breakdown-fill-geo {
    background: #10b981;
}

.device-breakdown {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 1rem;
}

.device-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.device-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.5rem;
}

.device-icon-desktop { background: #e3f2fd; color: #1976d2; }
.device-icon-mobile { background: #e8f5e9; color: #388e3c; }
.device-icon-tablet { background: #fff3e0; color: #f57c00; }
.device-icon-bot { background: #f3e5f5; color: #7b1fa2; }

.device-type {
    font-size: 0.875rem;
    color: var(--text-primary);
    text-transform: capitalize;
}

.device-percent {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.empty-state {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
}

.settings-section {
    margin-top: 1.5rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-check {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}

.form-check input[type="checkbox"] {
    width: 18px;
    height: 18px;
}

.form-hint {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
}

.form-control-sm {
    max-width: 150px;
}

@media (max-width: 1024px) {
    .stats-grid-4 {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .stats-grid-4 {
        grid-template-columns: 1fr;
    }

    .analytics-grid {
        grid-template-columns: 1fr;
    }

    .chart-card {
        grid-column: span 1;
    }
}
</style>

<script>
// Update real-time count every 30 seconds
setInterval(function() {
    fetch('/admin/page-analytics/api/realtime')
        .then(response => response.json())
        .then(data => {
            const el = document.getElementById('realtime-count');
            if (el) {
                el.textContent = data.visitors;
            }
        })
        .catch(err => console.error('Failed to fetch realtime stats:', err));
}, 30000);
</script>
{{end}}
