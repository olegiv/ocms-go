{{define "content"}}
<div class="page-header">
    <div>
        <h1 class="page-title">{{.Data.Theme.Config.Name}} {{T .AdminLang "themes.settings_title"}}</h1>
        <p class="page-description">{{T .AdminLang "themes.customize"}}</p>
    </div>
    <div class="page-actions">
        <a href="/admin/themes" class="btn btn-secondary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
            {{T .AdminLang "themes.back_to_themes"}}
        </a>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">{{T .AdminLang "themes.theme_settings"}}</h2>
        {{if .Data.Theme.IsActive}}
        <span class="badge badge-success">{{T .AdminLang "themes.active_theme"}}</span>
        {{end}}
    </div>
    <form method="POST" action="/admin/themes/{{.Data.Theme.Name}}/settings" class="card-body">
        {{.CSRFField}}
        <input type="hidden" name="_method" value="PUT">

        {{if .Data.Theme.Config.Settings}}
        <div class="settings-grid">
            {{range .Data.Theme.Config.Settings}}
            <div class="form-group">
                <label for="{{.Key}}" class="form-label">{{TDefault $.AdminLang (printf "theme_settings.%s" .Key) .Label}}</label>

                {{if eq .Type "color"}}
                <div class="color-input-wrapper">
                    <input
                        type="color"
                        id="{{.Key}}"
                        name="{{.Key}}"
                        class="color-input"
                        value="{{index $.Data.Settings .Key}}"
                    >
                    <input
                        type="text"
                        class="form-input color-text-input"
                        value="{{index $.Data.Settings .Key}}"
                        readonly
                    >
                </div>

                {{else if eq .Type "select"}}
                <select
                    id="{{.Key}}"
                    name="{{.Key}}"
                    class="form-select {{if index $.Data.Errors .Key}}is-invalid{{end}}"
                >
                    {{$currentValue := index $.Data.Settings .Key}}
                    {{range .Options}}
                    <option value="{{.}}" {{if eq . $currentValue}}selected{{end}}>{{TDefault $.AdminLang (printf "option.%s" .) .}}</option>
                    {{end}}
                </select>

                {{else if eq .Type "image"}}
                <div class="image-input-wrapper">
                    {{$imageValue := index $.Data.Settings .Key}}
                    {{if $imageValue}}
                    <div class="image-preview" id="preview-{{.Key}}">
                        <img src="{{$imageValue}}" alt="{{.Label}}" style="max-height: 48px; max-width: 120px; object-fit: contain; border-radius: 4px; border: 1px solid var(--color-border);">
                    </div>
                    {{else}}
                    <div class="image-preview" id="preview-{{.Key}}" style="display: none;">
                        <img src="" alt="{{.Label}}" style="max-height: 48px; max-width: 120px; object-fit: contain; border-radius: 4px; border: 1px solid var(--color-border);">
                    </div>
                    {{end}}
                    <input
                        type="text"
                        id="{{.Key}}"
                        name="{{.Key}}"
                        class="form-input {{if index $.Data.Errors .Key}}is-invalid{{end}}"
                        value="{{$imageValue}}"
                        placeholder="{{T $.AdminLang "themes.image_placeholder"}}"
                        onchange="updateImagePreview('{{.Key}}')"
                    >
                    <button type="button" class="btn btn-secondary btn-sm" onclick="openMediaPicker('{{.Key}}')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                        {{T $.AdminLang "themes.browse"}}
                    </button>
                    {{if $imageValue}}
                    <button type="button" class="btn btn-secondary btn-sm" onclick="clearImageField('{{.Key}}')" title="{{T $.AdminLang "btn.clear"}}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                    {{end}}
                </div>
                {{if eq .Key "favicon"}}
                <span class="form-hint">{{T $.AdminLang "theme_settings.favicon_hint"}}</span>
                {{end}}

                {{else}}
                <input
                    type="text"
                    id="{{.Key}}"
                    name="{{.Key}}"
                    class="form-input {{if index $.Data.Errors .Key}}is-invalid{{end}}"
                    value="{{index $.Data.Settings .Key}}"
                >
                {{end}}

                {{if index $.Data.Errors .Key}}
                <span class="form-error">{{index $.Data.Errors .Key}}</span>
                {{end}}
            </div>
            {{end}}
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                {{T .AdminLang "themes.save_settings"}}
            </button>
            <a href="/admin/themes" class="btn btn-secondary">{{T .AdminLang "btn.cancel"}}</a>
        </div>

        {{else}}
        <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            <p>{{T .AdminLang "themes.no_settings"}}</p>
            <span class="empty-hint">{{T .AdminLang "themes.no_settings_hint"}}</span>
        </div>
        {{end}}
    </form>
</div>
<script>
// Sync color input with text display
document.querySelectorAll('.color-input').forEach(function(colorInput) {
    const textInput = colorInput.nextElementSibling;
    colorInput.addEventListener('input', function() {
        textInput.value = this.value;
    });
});

// Validate URL to prevent XSS - only allow safe schemes and paths
function isValidImageUrl(url) {
    if (!url || typeof url !== 'string') return false;

    // Allow /uploads/ paths (media API returns these)
    if (url.startsWith('/uploads/')) return true;

    // Allow /static/ paths (theme assets)
    if (url.startsWith('/static/')) return true;

    // For other values, only allow absolute HTTP(S) URLs
    try {
        var parsed = new URL(url, window.location.origin);
        if (parsed.origin === window.location.origin) {
            // Relative URL resolved against current origin but not under allowed paths
            return false;
        }
        return parsed.protocol === 'http:' || parsed.protocol === 'https:';
    } catch (e) {
        // Invalid URL
        return false;
    }
}

// Safely set image src with validation
function safeSetImageSrc(img, url) {
    if (isValidImageUrl(url)) {
        // Use URL constructor to sanitize and escape meta-characters (satisfies CodeQL js/xss-through-dom)
        try {
            var sanitized = new URL(url, window.location.origin);
            img.src = sanitized.href;
            return true;
        } catch (e) {
            return false;
        }
    }
    return false;
}

// Update image preview when URL changes
function updateImagePreview(fieldId) {
    const input = document.getElementById(fieldId);
    const preview = document.getElementById('preview-' + fieldId);
    if (preview && input) {
        const img = preview.querySelector('img');
        if (input.value && safeSetImageSrc(img, input.value)) {
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    }
}

// Clear image field and hide preview
function clearImageField(fieldId) {
    const input = document.getElementById(fieldId);
    const preview = document.getElementById('preview-' + fieldId);
    if (input) {
        input.value = '';
    }
    if (preview) {
        preview.style.display = 'none';
    }
}

// Escape HTML to prevent XSS in dynamic content
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Open media picker modal
function openMediaPicker(fieldId) {
    // Create modal overlay
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.id = 'media-picker-overlay';
    overlay.onclick = function(e) {
        if (e.target === overlay) closeMediaPicker();
    };

    // Create modal content
    const modal = document.createElement('div');
    modal.className = 'modal media-picker-modal';
    modal.innerHTML = `
        <div class="modal-header">
            <h3>{{T .AdminLang "media.select_image"}}</h3>
            <button type="button" class="modal-close" onclick="closeMediaPicker()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="media-picker-content" class="media-picker-loading">
                {{T .AdminLang "media.loading"}}...
            </div>
        </div>
    `;

    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    document.body.classList.add('modal-open');

    // Load media items using correct API endpoint and field names
    fetch('/admin/media/api?type=image&limit=50')
        .then(response => response.json())
        .then(data => {
            const content = document.getElementById('media-picker-content');
            if (data.items && data.items.length > 0) {
                content.className = 'media-picker-grid';
                content.innerHTML = '';
                data.items.forEach(item => {
                    // Validate URLs before using them
                    const filepath = item.filepath || '';
                    const thumbnail = item.thumbnail || filepath;
                    const filename = item.filename || '';

                    if (!isValidImageUrl(filepath)) return;

                    const div = document.createElement('div');
                    div.className = 'media-picker-item';
                    div.onclick = function() { selectMedia(fieldId, filepath); };

                    const img = document.createElement('img');
                    safeSetImageSrc(img, thumbnail);
                    img.alt = escapeHtml(filename);

                    const span = document.createElement('span');
                    span.className = 'media-picker-filename';
                    span.textContent = filename;

                    div.appendChild(img);
                    div.appendChild(span);
                    content.appendChild(div);
                });
                if (content.children.length === 0) {
                    content.innerHTML = '<p style="text-align: center; padding: 2rem;">{{T .AdminLang "media.no_media"}}</p>';
                }
            } else {
                content.innerHTML = '<p style="text-align: center; padding: 2rem;">{{T .AdminLang "media.no_media"}}</p>';
            }
        })
        .catch(() => {
            document.getElementById('media-picker-content').innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--color-danger);">{{T .AdminLang "error.loading_failed"}}</p>';
        });
}

function closeMediaPicker() {
    const overlay = document.getElementById('media-picker-overlay');
    if (overlay) {
        overlay.remove();
        document.body.classList.remove('modal-open');
    }
}

function selectMedia(fieldId, url) {
    if (!isValidImageUrl(url)) return;
    const input = document.getElementById(fieldId);
    if (input) {
        input.value = url;
        updateImagePreview(fieldId);
    }
    closeMediaPicker();
}
</script>
<style>
.media-picker-modal {
    width: 90%;
    max-width: 800px;
    max-height: 80vh;
}
.media-picker-modal .modal-body {
    overflow-y: auto;
    max-height: 60vh;
}
.media-picker-loading {
    text-align: center;
    padding: 2rem;
    color: var(--color-text-muted);
}
.media-picker-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 1rem;
    padding: 0.5rem;
}
.media-picker-item {
    cursor: pointer;
    border: 2px solid transparent;
    border-radius: 8px;
    padding: 0.5rem;
    text-align: center;
    transition: border-color 0.2s, background-color 0.2s;
}
.media-picker-item:hover {
    border-color: var(--color-primary);
    background-color: var(--color-bg-secondary);
}
.media-picker-item img {
    width: 100%;
    height: 80px;
    object-fit: contain;
    border-radius: 4px;
    background: var(--color-bg-tertiary);
}
.media-picker-filename {
    display: block;
    font-size: 0.75rem;
    color: var(--color-text-muted);
    margin-top: 0.25rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.image-input-wrapper {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-wrap: wrap;
}
.image-preview {
    flex-shrink: 0;
}
.image-input-wrapper .form-input {
    flex: 1;
    min-width: 200px;
}
</style>
{{end}}
