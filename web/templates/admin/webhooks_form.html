{{define "content"}}
<div class="page-header">
    <div>
        <h1 class="page-title">{{if .Data.IsEdit}}{{T .AdminLang "webhooks.edit"}}{{else}}{{T .AdminLang "webhooks.new"}}{{end}}</h1>
        <p class="page-description">{{if .Data.IsEdit}}{{T .AdminLang "webhooks.edit_description"}}{{else}}{{T .AdminLang "webhooks.new_description"}}{{end}}</p>
    </div>
    <div class="page-actions">
        <a href="/admin/webhooks" class="btn btn-outline">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            {{T .AdminLang "webhooks.back_to_list"}}
        </a>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST" action="{{if .Data.IsEdit}}/admin/webhooks/{{.Data.Webhook.ID}}{{else}}/admin/webhooks{{end}}" class="form">
            {{if .Data.IsEdit}}
            <input type="hidden" name="_method" value="PUT">
            {{end}}

            <div class="form-group">
                <label for="name" class="form-label">{{T .AdminLang "webhooks.name"}} <span class="required">*</span></label>
                <input
                    type="text"
                    id="name"
                    name="name"
                    class="form-input{{if index .Data.Errors "name"}} is-invalid{{end}}"
                    value="{{index .Data.FormValues "name"}}"
                    placeholder="e.g., Production Notification, Analytics Sync"
                    required
                    autofocus
                >
                {{if index .Data.Errors "name"}}
                <span class="form-error">{{index .Data.Errors "name"}}</span>
                {{else}}
                <span class="form-hint">{{T .AdminLang "webhooks.name_hint"}}</span>
                {{end}}
            </div>

            <div class="form-group">
                <label for="url" class="form-label">{{T .AdminLang "webhooks.url"}} <span class="required">*</span></label>
                <input
                    type="url"
                    id="url"
                    name="url"
                    class="form-input{{if index .Data.Errors "url"}} is-invalid{{end}}"
                    value="{{index .Data.FormValues "url"}}"
                    placeholder="https://example.com/webhook"
                    required
                >
                {{if index .Data.Errors "url"}}
                <span class="form-error">{{index .Data.Errors "url"}}</span>
                {{else}}
                <span class="form-hint">{{T .AdminLang "webhooks.url_hint"}}</span>
                {{end}}
            </div>

            <div class="form-group">
                <label for="secret" class="form-label">{{T .AdminLang "webhooks.secret"}}</label>
                <div class="input-group" x-data="{ showSecret: false, copied: false }">
                    <input
                        :type="showSecret ? 'text' : 'password'"
                        id="secret"
                        name="secret"
                        class="form-input{{if index .Data.Errors "secret"}} is-invalid{{end}}"
                        value="{{index .Data.FormValues "secret"}}"
                        placeholder="{{if .Data.IsEdit}}Leave empty to keep existing{{else}}Auto-generated if empty{{end}}"
                    >
                    <button type="button" class="btn btn-outline input-group-btn" @click="showSecret = !showSecret" title="Toggle visibility">
                        <svg x-show="!showSecret" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                        <svg x-show="showSecret" x-cloak xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                    </button>
                    {{if .Data.IsEdit}}
                    <button type="button" class="btn btn-outline input-group-btn" @click="navigator.clipboard.writeText(document.getElementById('secret').value); copied = true; setTimeout(() => copied = false, 2000)" title="Copy">
                        <span x-show="!copied">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                        </span>
                        <span x-show="copied" x-cloak>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
                        </span>
                    </button>
                    {{end}}
                </div>
                {{if index .Data.Errors "secret"}}
                <span class="form-error">{{index .Data.Errors "secret"}}</span>
                {{else}}
                <span class="form-hint">{{T .AdminLang "webhooks.secret_hint"}}</span>
                {{end}}
            </div>

            <div class="form-group">
                <label class="form-label">{{T .AdminLang "webhooks.events"}} <span class="required">*</span></label>
                {{if index .Data.Errors "events"}}
                <span class="form-error" style="display: block; margin-bottom: 0.5rem;">{{index .Data.Errors "events"}}</span>
                {{end}}

                <div class="events-grid">
                    <div class="event-group">
                        <h4 class="event-group-title">Pages</h4>
                        {{range .Data.Events}}
                        {{if hasPrefix .Type "page."}}
                        <label class="checkbox-label">
                            <input type="checkbox" name="events" value="{{.Type}}"
                                {{if contains $.Data.FormEvents .Type}}checked{{end}}>
                            <span class="checkbox-text">
                                <strong>{{.Type}}</strong>
                                <small>{{.Description}}</small>
                            </span>
                        </label>
                        {{end}}
                        {{end}}
                    </div>

                    <div class="event-group">
                        <h4 class="event-group-title">Media</h4>
                        {{range .Data.Events}}
                        {{if hasPrefix .Type "media."}}
                        <label class="checkbox-label">
                            <input type="checkbox" name="events" value="{{.Type}}"
                                {{if contains $.Data.FormEvents .Type}}checked{{end}}>
                            <span class="checkbox-text">
                                <strong>{{.Type}}</strong>
                                <small>{{.Description}}</small>
                            </span>
                        </label>
                        {{end}}
                        {{end}}
                    </div>

                    <div class="event-group">
                        <h4 class="event-group-title">Other</h4>
                        {{range .Data.Events}}
                        {{if and (not (hasPrefix .Type "page.")) (not (hasPrefix .Type "media."))}}
                        <label class="checkbox-label">
                            <input type="checkbox" name="events" value="{{.Type}}"
                                {{if contains $.Data.FormEvents .Type}}checked{{end}}>
                            <span class="checkbox-text">
                                <strong>{{.Type}}</strong>
                                <small>{{.Description}}</small>
                            </span>
                        </label>
                        {{end}}
                        {{end}}
                    </div>
                </div>
            </div>

            <div class="form-group" x-data="{ headers: {{if .Data.FormHeaders}}{{toJSON .Data.FormHeaders}}{{else}}{}{{end}} }">
                <label class="form-label">{{T .AdminLang "webhooks.custom_headers"}}</label>
                <span class="form-hint" style="display: block; margin-bottom: 0.5rem;">{{T .AdminLang "webhooks.headers_hint"}}</span>

                <div class="headers-editor">
                    <template x-for="(value, key) in headers" :key="key">
                        <div class="header-row">
                            <input type="text" name="header_key" class="form-input header-key" :value="key" placeholder="Header name" readonly>
                            <input type="text" name="header_value" class="form-input header-value" :value="value" placeholder="Header value" readonly>
                            <button type="button" class="btn btn-sm btn-danger" @click="delete headers[key]; headers = {...headers}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/></svg>
                            </button>
                        </div>
                    </template>

                    <div class="header-row add-header" x-data="{ newKey: '', newValue: '' }">
                        <input type="text" class="form-input header-key" x-model="newKey" placeholder="Header name">
                        <input type="text" class="form-input header-value" x-model="newValue" placeholder="Header value">
                        <button type="button" class="btn btn-sm btn-outline" @click="if (newKey.trim()) { headers[newKey.trim()] = newValue; newKey = ''; newValue = ''; }">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>
                        </button>
                    </div>

                    <!-- Hidden inputs for actual form submission -->
                    <template x-for="(value, key) in headers" :key="'hidden-'+key">
                        <div>
                            <input type="hidden" name="header_key" :value="key">
                            <input type="hidden" name="header_value" :value="value">
                        </div>
                    </template>
                </div>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="is_active" value="on"
                        {{if eq (index .Data.FormValues "is_active") "1"}}checked{{end}}
                        {{if and (not .Data.IsEdit) (not (index .Data.FormValues "is_active"))}}checked{{end}}>
                    <span class="checkbox-text">
                        <strong>{{T .AdminLang "webhooks.active"}}</strong>
                        <small>{{T .AdminLang "webhooks.active_hint"}}</small>
                    </span>
                </label>
            </div>

            {{if .Data.IsEdit}}
            <div class="form-group">
                <label class="form-label">{{T .AdminLang "webhooks.info"}}</label>
                <div class="info-box">
                    <div class="info-row">
                        <span class="info-label">{{T .AdminLang "webhooks.created"}}:</span>
                        <span>{{formatDateTime .Data.Webhook.CreatedAt}}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">{{T .AdminLang "webhooks.updated"}}:</span>
                        <span>{{formatDateTime .Data.Webhook.UpdatedAt}}</span>
                    </div>
                </div>
            </div>
            {{end}}

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    {{if .Data.IsEdit}}{{T .AdminLang "webhooks.update"}}{{else}}{{T .AdminLang "webhooks.create"}}{{end}}
                </button>
                <a href="/admin/webhooks" class="btn btn-outline">{{T .AdminLang "btn.cancel"}}</a>
            </div>
        </form>
    </div>
</div>

<style>
.input-group {
    display: flex;
    gap: 0;
}

.input-group .form-input {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
    flex: 1;
}

.input-group-btn {
    border-radius: 0;
    border-left: 0;
}

.input-group-btn:last-child {
    border-top-right-radius: 8px;
    border-bottom-right-radius: 8px;
}

.events-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
}

.event-group {
    background: var(--bg-muted);
    padding: 1rem;
    border-radius: 8px;
}

.event-group-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.checkbox-label {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.5rem 0;
    cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
    margin-top: 0.25rem;
}

.checkbox-text {
    display: flex;
    flex-direction: column;
}

.checkbox-text strong {
    font-family: var(--font-mono);
    font-size: 0.875rem;
}

.checkbox-text small {
    color: var(--text-muted);
    font-size: 0.75rem;
}

.headers-editor {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.header-row {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.header-key {
    flex: 1;
    max-width: 200px;
}

.header-value {
    flex: 2;
}

.info-box {
    background: var(--bg-muted);
    padding: 1rem;
    border-radius: 8px;
}

.info-row {
    display: flex;
    padding: 0.375rem 0;
}

.info-label {
    font-weight: 500;
    width: 100px;
    flex-shrink: 0;
}
</style>
{{end}}
