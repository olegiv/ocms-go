{{define "content"}}
<div class="page-header">
    <h1 class="page-title">{{if .Data.IsEdit}}{{T .AdminLang "forms.edit"}}{{else}}{{T .AdminLang "forms.new"}}{{end}}</h1>
    <div class="page-actions">
        <a href="/admin/forms" class="btn btn-secondary">{{T .AdminLang "forms.back_to_forms"}}</a>
        {{if .Data.IsEdit}}
        <a href="/admin/forms/{{.Data.Form.ID}}/submissions" class="btn btn-secondary">{{T .AdminLang "forms.view_submissions"}}</a>
        <a href="/forms/{{.Data.Form.Slug}}" class="btn btn-outline" target="_blank">{{T .AdminLang "forms.preview"}}</a>
        {{end}}
    </div>
</div>

<div class="form-builder-container">
    <div class="form-builder-main">
        <!-- Form Settings -->
        <div class="card">
            <div class="card-header">
                <h3>{{T .AdminLang "forms.form_settings"}}</h3>
            </div>
            <div class="card-body">
                <form method="POST" action="{{if .Data.IsEdit}}/admin/forms/{{.Data.Form.ID}}{{else}}/admin/forms{{end}}">
                    {{.CSRFField}}
                    {{if .Data.IsEdit}}
                    <input type="hidden" name="_method" value="PUT">
                    {{end}}

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="name" class="form-label">{{T .AdminLang "forms.internal_name"}} *</label>
                            <input type="text"
                                   id="name"
                                   name="name"
                                   class="form-input{{if .Data.Errors.name}} is-invalid{{end}}"
                                   value="{{if .Data.IsEdit}}{{.Data.Form.Name}}{{else}}{{index .Data.FormValues "name"}}{{end}}"
                                   required
                                   maxlength="255">
                            {{if .Data.Errors.name}}
                            <div class="form-error">{{.Data.Errors.name}}</div>
                            {{end}}
                            <small class="form-text">{{T .AdminLang "forms.internal_name_hint"}}</small>
                        </div>

                        <div class="form-group col-md-6">
                            <label for="slug" class="form-label">{{T .AdminLang "label.slug"}} *</label>
                            <input type="text"
                                   id="slug"
                                   name="slug"
                                   class="form-input{{if .Data.Errors.slug}} is-invalid{{end}}"
                                   value="{{if .Data.IsEdit}}{{.Data.Form.Slug}}{{else}}{{index .Data.FormValues "slug"}}{{end}}"
                                   pattern="[a-z0-9-]+"
                                   placeholder="auto-generated-from-name"
                                   maxlength="255">
                            {{if .Data.Errors.slug}}
                            <div class="form-error">{{.Data.Errors.slug}}</div>
                            {{end}}
                            <small class="form-text">{{T .AdminLang "forms.slug_hint"}}</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="title" class="form-label">{{T .AdminLang "forms.display_title"}} *</label>
                        <input type="text"
                               id="title"
                               name="title"
                               class="form-input{{if .Data.Errors.title}} is-invalid{{end}}"
                               value="{{if .Data.IsEdit}}{{.Data.Form.Title}}{{else}}{{index .Data.FormValues "title"}}{{end}}"
                               required
                               maxlength="255">
                        {{if .Data.Errors.title}}
                        <div class="form-error">{{.Data.Errors.title}}</div>
                        {{end}}
                        <small class="form-text">{{T .AdminLang "forms.display_title_hint"}}</small>
                    </div>

                    <div class="form-group">
                        <label for="description" class="form-label">{{T .AdminLang "label.description"}}</label>
                        <textarea id="description"
                                  name="description"
                                  class="form-input"
                                  rows="2">{{if .Data.IsEdit}}{{.Data.Form.Description.String}}{{else}}{{index .Data.FormValues "description"}}{{end}}</textarea>
                        <small class="form-text">{{T .AdminLang "forms.description_hint"}}</small>
                    </div>

                    <div class="form-group">
                        <label for="success_message" class="form-label">{{T .AdminLang "forms.success_message"}}</label>
                        <textarea id="success_message"
                                  name="success_message"
                                  class="form-input"
                                  rows="2">{{if .Data.IsEdit}}{{.Data.Form.SuccessMessage.String}}{{else}}{{or (index .Data.FormValues "success_message") (T .AdminLang "forms.default_success")}}{{end}}</textarea>
                        <small class="form-text">{{T .AdminLang "forms.success_message_hint"}}</small>
                    </div>

                    <div class="form-group">
                        <label for="email_to" class="form-label">{{T .AdminLang "forms.notification_email"}}</label>
                        <input type="email"
                               id="email_to"
                               name="email_to"
                               class="form-input"
                               value="{{if .Data.IsEdit}}{{.Data.Form.EmailTo.String}}{{else}}{{index .Data.FormValues "email_to"}}{{end}}"
                               placeholder="admin@example.com"
                               maxlength="255">
                        <small class="form-text">{{T .AdminLang "forms.notification_email_hint"}}</small>
                    </div>

                    <div class="form-group">
                        <label class="form-checkbox">
                            <input type="checkbox"
                                   name="is_active"
                                   value="true"
                                   {{if .Data.IsEdit}}{{if .Data.Form.IsActive}}checked{{end}}{{else}}{{if eq (index .Data.FormValues "is_active") "true"}}checked{{end}}{{end}}>
                            <span>{{T .AdminLang "forms.is_active"}}</span>
                        </label>
                    </div>

                    {{if gt (len .Data.AllLanguages) 1}}
                    <div class="form-group">
                        <label for="language_code" class="form-label">{{T .AdminLang "label.language"}}</label>
                        <select
                            id="language_code"
                            name="language_code"
                            class="form-select"
                            {{if .Data.IsEdit}}disabled{{end}}
                        >
                            {{$currentLanguageCode := ""}}
                            {{if .Data.FormValues.language_code}}
                                {{$currentLanguageCode = .Data.FormValues.language_code}}
                            {{else if .Data.Language}}
                                {{$currentLanguageCode = .Data.Language.Code}}
                            {{else if .Data.Form}}
                                {{$currentLanguageCode = .Data.Form.LanguageCode}}
                            {{end}}
                            {{range .Data.AllLanguages}}
                            <option value="{{.Code}}" {{if eq .Code $currentLanguageCode}}selected{{end}}>
                                {{.Name}} ({{.Code}})
                            </option>
                            {{end}}
                        </select>
                        {{if .Data.IsEdit}}
                        <input type="hidden" name="language_code" value="{{if .Data.Language}}{{.Data.Language.Code}}{{end}}">
                        <small class="form-text">{{T .AdminLang "forms.language_readonly"}}</small>
                        {{else}}
                        <small class="form-text">{{T .AdminLang "forms.select_language"}}</small>
                        {{end}}
                    </div>
                    {{else if .Data.Language}}
                    <input type="hidden" name="language_code" value="{{.Data.Language.Code}}">
                    {{end}}

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            {{if .Data.IsEdit}}{{T .AdminLang "forms.update_form"}}{{else}}{{T .AdminLang "forms.create_form"}}{{end}}
                        </button>
                        <a href="/admin/forms" class="btn btn-secondary">{{T .AdminLang "btn.cancel"}}</a>
                    </div>
                </form>
            </div>
        </div>

        {{if .Data.IsEdit}}
        <!-- Field Builder -->
        <div class="card mt-4" x-data="formFieldBuilder()">
            <div class="card-header">
                <h3>{{T .AdminLang "forms.form_fields"}}</h3>
                <button type="button" class="btn btn-primary btn-sm" @click="openAddModal()">
                    {{T .AdminLang "forms.add_field"}}
                </button>
            </div>
            <div class="card-body">
                <template x-if="fields.length === 0">
                    <div class="empty-state">
                        <p>{{T .AdminLang "forms.no_fields"}}</p>
                    </div>
                </template>

                <div id="fields-list" class="fields-list" x-sort="handleSort" x-sort:config="{ handle: '.field-item-handle' }">
                    <template x-for="field in fields" :key="`${field.id}-${sortIteration}`">
                        <div class="field-item" x-sort:item="field.id">
                            <div class="field-item-handle" x-sort:handle>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="8" y1="6" x2="16" y2="6"></line>
                                    <line x1="8" y1="12" x2="16" y2="12"></line>
                                    <line x1="8" y1="18" x2="16" y2="18"></line>
                                </svg>
                            </div>
                            <div class="field-item-content">
                                <div class="field-item-label" x-text="field.label"></div>
                                <div class="field-item-meta">
                                    <span class="badge badge-secondary" x-text="field.type"></span>
                                    <code x-text="field.name"></code>
                                    <span class="badge badge-primary" x-show="field.is_required">{{T .AdminLang "forms.required"}}</span>
                                </div>
                            </div>
                            <div class="field-item-actions">
                                <button type="button" class="btn btn-sm btn-secondary" @click="openEditModal(field)">
                                    {{T .AdminLang "btn.edit"}}
                                </button>
                                <button type="button" class="btn btn-sm btn-danger" @click="deleteField(field.id)">
                                    {{T .AdminLang "btn.delete"}}
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Add/Edit Field Modal (inside Alpine component) -->
            <template x-if="showModal">
                <div class="modal-overlay" x-show="showModal" @click.self="closeModal()" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;">
                    <div class="modal" @click.stop style="background:white;border-radius:8px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;">
                        <div class="modal-header" style="padding:1rem;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                            <h3 class="modal-title" x-text="editingField?.id ? '{{T .AdminLang "forms.edit_field"}}' : '{{T .AdminLang "forms.add_field"}}'"></h3>
                            <button type="button" class="modal-close" @click="closeModal()" aria-label="{{T .AdminLang "btn.close"}}">&times;</button>
                        </div>
                        <div class="modal-body" style="padding:1rem;">
                            <div class="form-group">
                                <label class="form-label">{{T .AdminLang "forms.field_type"}} *</label>
                                <select class="form-input" x-model="editingField.type">
                                    <template x-for="t in (editingField && editingField.id ? fieldTypes : getAvailableFieldTypes())" :key="t">
                                        <option :value="t" x-text="t"></option>
                                    </template>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">{{T .AdminLang "forms.field_label"}} *</label>
                                <input type="text" class="form-input" x-model="editingField.label" maxlength="255">
                            </div>

                            <div class="form-group" x-show="editingField && editingField.type !== 'captcha'">
                                <label class="form-label">{{T .AdminLang "forms.field_name"}}</label>
                                <input type="text" class="form-input" x-model="editingField.name" placeholder="auto-generated" maxlength="255">
                                <small class="form-text">{{T .AdminLang "forms.field_name_hint"}}</small>
                            </div>

                            <div class="form-group" x-show="editingField && editingField.type !== 'captcha'">
                                <label class="form-label">{{T .AdminLang "forms.field_placeholder"}}</label>
                                <input type="text" class="form-input" x-model="editingField.placeholder" maxlength="255">
                            </div>

                            <div class="form-group" x-show="editingField && editingField.type !== 'captcha'">
                                <label class="form-label">{{T .AdminLang "forms.field_help_text"}}</label>
                                <input type="text" class="form-input" x-model="editingField.help_text" maxlength="255">
                                <small class="form-text">{{T .AdminLang "forms.field_help_hint"}}</small>
                            </div>

                            <div class="form-group" x-show="showOptionsField()">
                                <label class="form-label">{{T .AdminLang "forms.field_options"}}</label>
                                <textarea class="form-input" rows="4" x-model="editingField.options" placeholder="Option 1&#10;Option 2&#10;Option 3"></textarea>
                                <small class="form-text">{{T .AdminLang "forms.field_options_hint"}}</small>
                            </div>

                            <!-- Captcha field info -->
                            <template x-if="editingField && editingField.type === 'captcha'">
                                <div class="alert alert-info" style="margin-bottom: 1rem;">
                                    <strong>{{T .AdminLang "forms.captcha_info_title"}}</strong>
                                    <p style="margin: 0.5rem 0 0 0;">{{T .AdminLang "forms.captcha_info_text"}}</p>
                                    {{if not (hcaptchaEnabled)}}
                                    <div class="alert alert-warning" style="margin-top: 0.5rem; margin-bottom: 0;">
                                        <strong>{{T .AdminLang "forms.captcha_warning_title"}}</strong>
                                        {{T .AdminLang "forms.captcha_warning_text"}}
                                        <a href="/admin/hcaptcha">{{T .AdminLang "forms.captcha_configure_link"}}</a>
                                    </div>
                                    {{end}}
                                </div>
                            </template>

                            <div class="form-group" x-show="editingField && editingField.type !== 'captcha'">
                                <label class="checkbox-label">
                                    <input type="checkbox" x-model="editingField.is_required">
                                    <span>{{T .AdminLang "forms.field_required"}}</span>
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer" style="padding:1rem;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:0.5rem;">
                            <button type="button" class="btn btn-outline" @click="closeModal()">{{T .AdminLang "btn.cancel"}}</button>
                            <button type="button" class="btn btn-primary" @click="saveField()">{{T .AdminLang "forms.save_field"}}</button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
        {{end}}

        <!-- Translations Panel (Edit mode only) - Outside main form to avoid nested forms -->
        {{if and .Data.IsEdit (gt (len .Data.AllLanguages) 1)}}
        <div class="card mt-4">
            <div class="card-header">
                <h3>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg>
                    {{T .AdminLang "forms.translations"}}
                </h3>
                {{if .Data.Language}}
                <span class="current-language-badge">
                    {{T .AdminLang "forms.current_language"}}: {{.Data.Language.Name}}
                </span>
                {{end}}
            </div>
            <div class="card-body">
                {{if .Data.Translations}}
                <div class="translations-list">
                    <h4 class="translations-subtitle">{{T .AdminLang "forms.existing_translations"}}</h4>
                    {{range .Data.Translations}}
                    <div class="translation-item">
                        <div class="translation-info">
                            <span class="translation-lang-badge" title="{{.Language.NativeName}}">{{.Language.Code}}</span>
                            <a href="/admin/forms/{{.Form.ID}}" class="translation-link">
                                {{.Form.Name}}
                            </a>
                        </div>
                    </div>
                    {{end}}
                </div>
                {{end}}

                {{if .Data.MissingLanguages}}
                <div class="translations-add">
                    <h4 class="translations-subtitle">{{T .AdminLang "forms.add_translation"}}</h4>
                    <div class="translation-buttons">
                        {{range .Data.MissingLanguages}}
                        <form action="/admin/forms/{{$.Data.Form.ID}}/translate/{{.Code}}" method="POST" class="inline-form">
                            {{$.CSRFField}}
                            <button type="submit" class="btn btn-sm btn-outline translation-add-btn" title="Create {{.Name}} translation">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                                {{.Code}} - {{.Name}}
                            </button>
                        </form>
                        {{end}}
                    </div>
                </div>
                {{end}}

                {{if and (not .Data.Translations) (not .Data.MissingLanguages)}}
                <p class="translations-empty">{{T .AdminLang "forms.all_translations_exist"}}</p>
                {{end}}
            </div>
        </div>
        {{end}}
    </div>
</div>

{{if .Data.IsEdit}}
<script>
function formFieldBuilder() {
    return {
        formId: {{.Data.Form.ID}},
        fields: {{toJSON .Data.Fields}},
        sortIteration: 0,
        showModal: false,
        editingField: null,
        fieldTypes: [{{range $i, $t := .Data.FieldTypes}}{{if $i}},{{end}}'{{$t}}'{{end}}],

        init() {
            // Parse fields to ensure correct format
            // Note: Go sql.NullString serializes as {"String": "value", "Valid": true}
            this.fields = (this.fields || []).map(f => ({
                id: f.id,
                type: f.type,
                name: f.name,
                label: f.label,
                placeholder: f.placeholder?.String || '',
                help_text: f.help_text?.String || '',
                options: f.options?.String || '[]',
                validation: f.validation?.String || '{}',
                is_required: f.is_required ?? false
            }));
        },

        handleSort(fieldId, newPosition) {
            const oldIndex = this.fields.findIndex(f => f.id == fieldId);
            if (oldIndex !== -1 && oldIndex !== newPosition) {
                const [field] = this.fields.splice(oldIndex, 1);
                this.fields.splice(newPosition, 0, field);
                this.sortIteration++;  // Force Alpine to recreate DOM elements
                this.saveOrder();
            }
        },

        async saveOrder() {
            const fieldIds = this.fields.map(f => f.id);
            try {
                await fetch(`/admin/forms/${this.formId}/fields/reorder`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ field_ids: fieldIds })
                });
            } catch (e) {
                console.error('Failed to save field order:', e);
            }
        },

        openAddModal() {
            this.editingField = {
                id: null,
                type: this.fieldTypes[0],
                name: '',
                label: '',
                placeholder: '',
                help_text: '',
                options: '',
                is_required: false
            };
            this.showModal = true;
        },

        hasCaptchaField() {
            return this.fields.some(f => f.type === 'captcha');
        },

        getAvailableFieldTypes() {
            // Filter out captcha if one already exists
            if (this.hasCaptchaField()) {
                return this.fieldTypes.filter(t => t !== 'captcha');
            }
            return this.fieldTypes;
        },

        openEditModal(field) {
            let optionsText = '';
            if (field.options && field.options !== '[]') {
                try {
                    const arr = JSON.parse(field.options);
                    optionsText = arr.join('\n');
                } catch (e) {}
            }
            this.editingField = {
                id: field.id,
                type: field.type,
                name: field.name,
                label: field.label,
                placeholder: field.placeholder,
                help_text: field.help_text,
                options: optionsText,
                is_required: field.is_required
            };
            this.showModal = true;
        },

        closeModal() {
            this.showModal = false;
            this.editingField = null;
        },

        showOptionsField() {
            return this.editingField && ['select', 'radio', 'checkbox'].includes(this.editingField.type);
        },

        async saveField() {
            if (!this.editingField || !this.editingField.label.trim()) {
                alert('Label is required');
                return;
            }

            let options = '[]';
            if (this.editingField.options.trim()) {
                const arr = this.editingField.options.split('\n').map(o => o.trim()).filter(o => o);
                options = JSON.stringify(arr);
            }

            const data = {
                type: this.editingField.type,
                label: this.editingField.label,
                name: this.editingField.name,
                placeholder: this.editingField.placeholder,
                help_text: this.editingField.help_text,
                options: options,
                validation: '{}',
                is_required: this.editingField.is_required
            };

            const url = this.editingField.id
                ? `/admin/forms/${this.formId}/fields/${this.editingField.id}`
                : `/admin/forms/${this.formId}/fields`;
            const method = this.editingField.id ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    window.location.reload();
                } else {
                    alert('Error saving field');
                }
            } catch (e) {
                console.error('Failed to save field:', e);
                alert('Error saving field');
            }
        },

        async deleteField(fieldId) {
            if (!confirm('{{T .AdminLang "label.confirm_delete"}}')) return;

            try {
                const response = await fetch(`/admin/forms/${this.formId}/fields/${fieldId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    this.fields = this.fields.filter(f => f.id !== fieldId);
                } else {
                    alert('Error deleting field');
                }
            } catch (e) {
                console.error('Failed to delete field:', e);
                alert('Error deleting field');
            }
        }
    };
}
</script>
{{end}}
{{end}}
