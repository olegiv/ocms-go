{{define "content"}}
<div class="page-header">
    <div>
        <h1 class="page-title">{{T .AdminLang "events.title"}}</h1>
        <p class="page-description">{{T .AdminLang "events.description"}} ({{.Data.TotalEvents}} {{T .AdminLang "label.total"}})</p>
    </div>
</div>

<!-- Filters -->
<div class="card card-filters">
    <div class="filter-bar">
        <form method="get" action="/admin/events" class="filter-form">
            <div class="filter-group">
                <label for="level" class="filter-label">{{T .AdminLang "events.level"}}</label>
                <select name="level" id="level" class="form-select form-select-sm">
                    <option value="">{{T .AdminLang "events.all_levels"}}</option>
                    {{range .Data.Levels}}
                    <option value="{{.}}" {{if eq . $.Data.Level}}selected{{end}}>{{.}}</option>
                    {{end}}
                </select>
            </div>
            <div class="filter-group">
                <label for="category" class="filter-label">{{T .AdminLang "events.category"}}</label>
                <select name="category" id="category" class="form-select form-select-sm">
                    <option value="">{{T .AdminLang "events.all_categories"}}</option>
                    {{range .Data.Categories}}
                    <option value="{{.}}" {{if eq . $.Data.Category}}selected{{end}}>{{.}}</option>
                    {{end}}
                </select>
            </div>
            <div class="filter-actions">
                <button type="submit" class="btn btn-sm btn-primary">{{T .AdminLang "events.filter"}}</button>
                {{if or .Data.Level .Data.Category}}
                <a href="/admin/events" class="btn btn-sm btn-outline">{{T .AdminLang "events.clear"}}</a>
                {{end}}
            </div>
        </form>
    </div>
</div>

{{if .Data.Events}}
<div class="card" id="events-table">
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>{{T .AdminLang "events.time"}}</th>
                    <th>{{T .AdminLang "events.level"}}</th>
                    <th>{{T .AdminLang "events.category"}}</th>
                    <th>{{T .AdminLang "events.message"}}</th>
                    <th>{{T .AdminLang "events.details"}}</th>
                    <th>{{T .AdminLang "events.url"}}</th>
                    <th>{{T .AdminLang "events.ip_address"}}</th>
                    <th>{{T .AdminLang "events.user"}}</th>
                </tr>
            </thead>
            <tbody>
                {{range .Data.Events}}
                <tr class="event-row event-level-{{.Level}}">
                    <td class="event-time">{{.CreatedAt}}</td>
                    <td>
                        <span class="badge badge-{{if eq .Level "error"}}danger{{else if eq .Level "warning"}}warning{{else}}info{{end}}">
                            {{.Level}}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-secondary">{{.Category}}</span>
                    </td>
                    <td class="event-message">{{.Message}}</td>
                    <td class="event-details">
                        {{if .Details}}
                            <span class="details-text">{{.Details}}</span>
                        {{else}}
                            <span class="text-muted">-</span>
                        {{end}}
                    </td>
                    <td class="event-url">
                        {{if .RequestURL}}
                            <span class="url-text"><code>{{.RequestURL}}</code></span>
                        {{else}}
                            <span class="text-muted">-</span>
                        {{end}}
                    </td>
                    <td class="event-ip">
                        {{if .IPAddress}}
                            <code class="text-muted">{{.IPAddress}}</code>
                            {{if sentinelIsActive}}
                                {{if sentinelIsIPBanned .IPAddress}}
                                    <span class="badge badge-danger ban-badge" data-ip="{{.IPAddress}}">{{T $.AdminLang "sentinel.banned"}}</span>
                                {{else if not (or .IsOwnIP (sentinelIsIPWhitelisted .IPAddress))}}
                                    <button type="button" class="btn btn-sm btn-danger ban-btn" data-ip="{{.IPAddress}}" onclick="banIP(this)">{{T $.AdminLang "sentinel.ban_action"}}</button>
                                {{end}}
                            {{end}}
                        {{else}}
                            <span class="text-muted">-</span>
                        {{end}}
                    </td>
                    <td>
                        {{if .UserName}}
                            <span class="text-muted">{{.UserName}}</span>
                        {{else}}
                            <span class="text-muted">{{T $.AdminLang "events.system"}}</span>
                        {{end}}
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>

    {{if .Data.Pagination.ShouldShow}}
    <div class="card-footer">
        {{template "pagination" (dict "Pagination" .Data.Pagination "AdminLang" .AdminLang)}}
    </div>
    {{end}}
</div>
{{else}}
<div class="card">
    <div class="card-body">
        <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
            <p>{{T .AdminLang "events.no_events"}}</p>
            {{if or .Data.Level .Data.Category}}
            <span class="empty-hint">{{T .AdminLang "events.no_events_filter"}}</span>
            <div class="empty-state-action">
                <a href="/admin/events" class="btn btn-primary">{{T .AdminLang "events.clear_filters"}}</a>
            </div>
            {{else}}
            <span class="empty-hint">{{T .AdminLang "events.no_events_hint"}}</span>
            {{end}}
        </div>
    </div>
</div>
{{end}}

{{if .Data.Events}}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.details-text, .url-text').forEach(function(el) {
        if (el.scrollWidth > el.clientWidth) {
            el.classList.add('truncated');
            el.addEventListener('click', function() {
                this.classList.toggle('expanded');
            });
        }
    });
});

function banIP(btn) {
    var ip = btn.getAttribute('data-ip');
    btn.disabled = true;
    btn.classList.add('btn-loading');

    fetch('/admin/sentinel/ban', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ip: ip })
    })
    .then(function(response) {
        if (response.redirected) {
            throw new Error('Sentinel module is not active');
        }
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            showToast('IP ' + ip + ' banned', 'success');
            document.querySelectorAll('.ban-btn[data-ip="' + ip + '"]').forEach(function(el) {
                var badge = document.createElement('span');
                badge.className = 'badge badge-danger ban-badge';
                badge.setAttribute('data-ip', ip);
                badge.textContent = 'Banned';
                el.replaceWith(badge);
            });
        } else {
            showToast(data.error || 'Failed to ban IP', 'error');
            btn.disabled = false;
            btn.classList.remove('btn-loading');
        }
    })
    .catch(function(err) {
        showToast(err.message || 'Failed to ban IP', 'error');
        btn.disabled = false;
        btn.classList.remove('btn-loading');
    });
}
</script>
{{end}}
{{end}}
