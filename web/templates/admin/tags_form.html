{{define "content"}}
<div class="page-header">
    <div>
        <h1 class="page-title">{{if .Data.IsEdit}}{{T .AdminLang "tags.edit"}}{{else}}{{T .AdminLang "tags.new"}}{{end}}</h1>
        <p class="page-description">{{if .Data.IsEdit}}{{T .AdminLang "tags.edit_description"}}{{else}}{{T .AdminLang "tags.new_description"}}{{end}}</p>
    </div>
    <div class="page-actions">
        <a href="/admin/tags" class="btn btn-outline">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            {{T .AdminLang "tags.back_to_tags"}}
        </a>
    </div>
</div>

<div class="card">
    <form
        id="tag-form"
        method="POST"
        action="{{if .Data.IsEdit}}/admin/tags/{{.Data.Tag.ID}}{{else}}/admin/tags{{end}}"
        class="card-body"
        x-data="tagForm()"
    >
        {{.CSRFField}}
        {{if .Data.IsEdit}}
        <input type="hidden" name="_method" value="PUT">
        {{end}}

        <div class="form-grid">
            <!-- Name -->
            <div class="form-group">
                <label for="name" class="form-label">
                    {{T .AdminLang "label.name"}} <span class="required">*</span>
                </label>
                <input
                    type="text"
                    id="name"
                    name="name"
                    class="form-input {{if .Data.Errors.name}}is-invalid{{end}}"
                    value="{{if .Data.FormValues.name}}{{.Data.FormValues.name}}{{else if .Data.Tag}}{{.Data.Tag.Name}}{{end}}"
                    placeholder="{{T .AdminLang "tags.name_placeholder"}}"
                    required
                    maxlength="255"
                    @input="generateSlug($event.target.value)"
                >
                {{if .Data.Errors.name}}
                <span class="form-error">{{.Data.Errors.name}}</span>
                {{else}}
                <span class="form-hint">{{T .AdminLang "tags.name_hint"}}</span>
                {{end}}
            </div>

            <!-- Slug -->
            <div class="form-group">
                <label for="slug" class="form-label">
                    {{T .AdminLang "label.slug"}} <span class="required">*</span>
                </label>
                <input
                    type="text"
                    id="slug"
                    name="slug"
                    class="form-input {{if .Data.Errors.slug}}is-invalid{{end}}"
                    value="{{if .Data.FormValues.slug}}{{.Data.FormValues.slug}}{{else if .Data.Tag}}{{.Data.Tag.Slug}}{{end}}"
                    placeholder="tag-slug"
                    x-model="slug"
                    @input="slugEdited = true"
                    maxlength="255"
                >
                {{if .Data.Errors.slug}}
                <span class="form-error">{{.Data.Errors.slug}}</span>
                {{else}}
                <span class="form-hint">{{T .AdminLang "tags.slug_hint"}}</span>
                {{end}}
            </div>

            <!-- Language -->
            {{if gt (len .Data.AllLanguages) 1}}
            <div class="form-group">
                <label for="language_code" class="form-label">{{T .AdminLang "label.language"}}</label>
                <select
                    id="language_code"
                    name="language_code"
                    class="form-select"
                    {{if .Data.IsEdit}}disabled{{end}}
                >
                    {{$currentLanguageCode := ""}}
                    {{if .Data.FormValues.language_code}}
                        {{$currentLanguageCode = .Data.FormValues.language_code}}
                    {{else if .Data.Language}}
                        {{$currentLanguageCode = .Data.Language.Code}}
                    {{else if .Data.Tag}}
                        {{$currentLanguageCode = .Data.Tag.LanguageCode}}
                    {{end}}
                    {{range .Data.AllLanguages}}
                    <option value="{{.Code}}" {{if eq .Code $currentLanguageCode}}selected{{end}}>
                        {{.Name}} ({{.Code}})
                    </option>
                    {{end}}
                </select>
                {{if .Data.IsEdit}}
                <input type="hidden" name="language_code" value="{{if .Data.Language}}{{.Data.Language.Code}}{{end}}">
                <span class="form-hint">{{T .AdminLang "tags.language_readonly"}}</span>
                {{else}}
                <span class="form-hint">{{T .AdminLang "tags.select_language"}}</span>
                {{end}}
            </div>
            {{else if .Data.Language}}
            <input type="hidden" name="language_code" value="{{.Data.Language.Code}}">
            {{end}}
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                {{if .Data.IsEdit}}
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                {{T .AdminLang "tags.update"}}
                {{else}}
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/><path d="M7 7h.01"/></svg>
                {{T .AdminLang "tags.create"}}
                {{end}}
            </button>
            <a href="/admin/tags" class="btn btn-outline">{{T .AdminLang "btn.cancel"}}</a>
        </div>
    </form>

    <!-- Translations Panel (Edit mode only) - Outside main form to avoid nested forms -->
    {{if and .Data.IsEdit (gt (len .Data.AllLanguages) 1)}}
    <div class="translations-panel" style="margin-top: 1.5rem; padding: 1rem;">
        <div class="translations-header">
            <h3 class="translations-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg>
                {{T .AdminLang "tags.translations"}}
            </h3>
            {{if .Data.Language}}
            <span class="current-language-badge">
                {{T .AdminLang "tags.current_language"}}: {{.Data.Language.Name}}
            </span>
            {{end}}
        </div>

        {{if .Data.Translations}}
        <div class="translations-list">
            <h4 class="translations-subtitle">{{T .AdminLang "tags.existing_translations"}}</h4>
            {{range .Data.Translations}}
            <div class="translation-item">
                <div class="translation-info">
                    <span class="translation-lang-badge" title="{{.Language.NativeName}}">{{.Language.Code}}</span>
                    <a href="/admin/tags/{{.Tag.ID}}" class="translation-link">
                        {{.Tag.Name}}
                    </a>
                </div>
            </div>
            {{end}}
        </div>
        {{end}}

        {{if .Data.MissingLanguages}}
        <div class="translations-add">
            <h4 class="translations-subtitle">{{T .AdminLang "tags.add_translation"}}</h4>
            <div class="translation-buttons">
                {{range .Data.MissingLanguages}}
                <form action="/admin/tags/{{$.Data.Tag.ID}}/translate/{{.Code}}" method="POST" class="inline-form">
                    {{$.CSRFField}}
                    <button type="submit" class="btn btn-sm btn-outline translation-add-btn" title="Create {{.Name}} translation">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                        {{.Code}} - {{.Name}}
                    </button>
                </form>
                {{end}}
            </div>
        </div>
        {{end}}

        {{if and (not .Data.Translations) (not .Data.MissingLanguages)}}
        <p class="translations-empty">{{T .AdminLang "tags.all_translations_exist"}}</p>
        {{end}}
    </div>
    {{end}}
</div>

<script>
function tagForm() {
    return {
        slug: '{{if .Data.FormValues.slug}}{{.Data.FormValues.slug}}{{else if .Data.Tag}}{{.Data.Tag.Slug}}{{end}}',
        slugEdited: {{if .Data.IsEdit}}true{{else}}false{{end}},
        generateSlug(value) {
            if (!this.slugEdited) {
                this.slug = value
                    .toLowerCase()
                    .trim()
                    .replace(/[^\w\s-]/g, '')
                    .replace(/[\s_-]+/g, '-')
                    .replace(/^-+|-+$/g, '');
            }
        }
    }
}
</script>
{{end}}
