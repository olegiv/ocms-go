{{define "content"}}
<div class="page-header">
    <div>
        <h1 class="page-title">{{T .AdminLang "analytics_int.title"}}</h1>
        <p class="page-description">{{T .AdminLang "analytics_int.description"}}</p>
    </div>
    <div class="page-actions">
        <div class="date-range-selector">
            <a href="?range=7d" class="btn btn-sm {{if eq .Data.DateRange "7d"}}btn-primary{{else}}btn-outline{{end}}">7d</a>
            <a href="?range=30d" class="btn btn-sm {{if eq .Data.DateRange "30d"}}btn-primary{{else}}btn-outline{{end}}">30d</a>
            <a href="?range=90d" class="btn btn-sm {{if eq .Data.DateRange "90d"}}btn-primary{{else}}btn-outline{{end}}">90d</a>
            <a href="?range=1y" class="btn btn-sm {{if eq .Data.DateRange "1y"}}btn-primary{{else}}btn-outline{{end}}">1y</a>
        </div>
    </div>
</div>

<!-- Overview Stats -->
<div class="stats-section">
    <div class="stats-grid stats-grid-4">
        <div class="stat-card">
            <div class="stat-icon stat-icon-blue">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-value">{{.Data.Overview.TotalViews}}</span>
                <span class="stat-label">{{T .AdminLang "analytics_int.total_views"}}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon stat-icon-green">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-value">{{.Data.Overview.UniqueVisitors}}</span>
                <span class="stat-label">{{T .AdminLang "analytics_int.unique_visitors"}}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon stat-icon-orange">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-value">{{printf "%.1f" .Data.Overview.BounceRate}}%</span>
                <span class="stat-label">{{T .AdminLang "analytics_int.bounce_rate"}}</span>
            </div>
        </div>
        <div class="stat-card stat-card-realtime">
            <div class="stat-icon stat-icon-purple">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
            </div>
            <div class="stat-content">
                <span class="stat-value" id="realtime-count">{{.Data.Overview.RealTimeVisitors}}</span>
                <span class="stat-label">{{T .AdminLang "analytics_int.realtime"}}</span>
            </div>
            <span class="realtime-dot"></span>
        </div>
    </div>
</div>

<!-- Today's Stats -->
<div class="today-stats">
    <div class="today-card">
        <span class="today-label">{{T .AdminLang "analytics_int.today"}}</span>
        <span class="today-value">{{.Data.Overview.ViewsToday}}</span>
        {{if ne .Data.Overview.ViewsYesterday 0}}
        <span class="today-trend {{if gt .Data.Overview.TrendPercent 0.0}}trend-up{{else if lt .Data.Overview.TrendPercent 0.0}}trend-down{{else}}trend-neutral{{end}}">
            {{if gt .Data.Overview.TrendPercent 0.0}}+{{end}}{{printf "%.1f" .Data.Overview.TrendPercent}}%
        </span>
        {{end}}
    </div>
</div>

<!-- Main Dashboard Grid -->
<div class="analytics-grid">
    <!-- Time Series Chart -->
    <div class="card chart-card">
        <div class="card-header">
            <h3>{{T .AdminLang "analytics_int.views_over_time"}}</h3>
        </div>
        <div class="card-body">
            {{if .Data.TimeSeries}}
            <div class="chart-container">
                <div class="bar-chart" id="views-chart">
                    {{range .Data.TimeSeries}}
                    <div class="bar-group" data-views="{{.Views}}" title="{{.Date}}: {{.Views}} views">
                        <div class="bar"></div>
                        <span class="bar-label">{{slice .Date 5 10}}</span>
                    </div>
                    {{end}}
                </div>
            </div>
            <script>
            (function() {
                const chart = document.getElementById('views-chart');
                if (!chart) return;
                const bars = chart.querySelectorAll('.bar-group');
                const maxHeight = 160; // Max bar height in pixels
                let maxViews = 1;
                bars.forEach(b => {
                    const v = parseInt(b.dataset.views) || 0;
                    if (v > maxViews) maxViews = v;
                });
                bars.forEach(b => {
                    const v = parseInt(b.dataset.views) || 0;
                    const height = Math.max(4, Math.round((v / maxViews) * maxHeight));
                    b.querySelector('.bar').style.height = height + 'px';
                });
            })();
            </script>
            {{else}}
            <div class="empty-state">
                <p>{{T .AdminLang "analytics_int.no_data"}}</p>
            </div>
            {{end}}
        </div>
    </div>

    <!-- Top Pages -->
    <div class="card">
        <div class="card-header">
            <h3>{{T .AdminLang "analytics_int.top_pages"}}</h3>
        </div>
        <div class="card-body">
            {{if .Data.TopPages}}
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>{{T .AdminLang "analytics_int.page"}}</th>
                        <th class="text-right">{{T .AdminLang "analytics_int.views"}}</th>
                        <th class="text-right">{{T .AdminLang "analytics_int.visitors"}}</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Data.TopPages}}
                    <tr>
                        <td class="page-path" title="{{.Path}}">{{.PageTitle}}</td>
                        <td class="text-right">{{.Views}}</td>
                        <td class="text-right">{{.UniqueVisitors}}</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
            {{else}}
            <div class="empty-state">
                <p>{{T .AdminLang "analytics_int.no_data"}}</p>
            </div>
            {{end}}
        </div>
    </div>

    <!-- Top Referrers -->
    <div class="card">
        <div class="card-header">
            <h3>{{T .AdminLang "analytics_int.top_referrers"}}</h3>
        </div>
        <div class="card-body">
            {{if .Data.TopReferrers}}
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>{{T .AdminLang "analytics_int.source"}}</th>
                        <th class="text-right">{{T .AdminLang "analytics_int.views"}}</th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Data.TopReferrers}}
                    <tr>
                        <td class="referrer-domain">{{if .Domain}}{{.Domain}}{{else}}(direct){{end}}</td>
                        <td class="text-right">{{.Views}}</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
            {{else}}
            <div class="empty-state">
                <p>{{T .AdminLang "analytics_int.no_referrer_data"}}</p>
            </div>
            {{end}}
        </div>
    </div>

    <!-- Browsers -->
    <div class="card">
        <div class="card-header">
            <h3>{{T .AdminLang "analytics_int.browsers"}}</h3>
        </div>
        <div class="card-body">
            {{if .Data.Browsers}}
            <div class="breakdown-list">
                {{range .Data.Browsers}}
                <div class="breakdown-item">
                    <div class="breakdown-info">
                        <span class="breakdown-name">{{.Browser}}</span>
                        <span class="breakdown-value">{{formatNumber .Views}} ({{printf "%.1f" .Percent}}%)</span>
                    </div>
                    <div class="breakdown-bar">
                        <div class="breakdown-fill" style="width: {{printf "%.0f" .Percent}}%"></div>
                    </div>
                </div>
                {{end}}
            </div>
            {{else}}
            <div class="empty-state">
                <p>{{T .AdminLang "analytics_int.no_data"}}</p>
            </div>
            {{end}}
        </div>
    </div>

    <!-- Devices -->
    <div class="card">
        <div class="card-header">
            <h3>{{T .AdminLang "analytics_int.devices"}}</h3>
        </div>
        <div class="card-body">
            {{if .Data.Devices}}
            <div class="device-breakdown">
                {{range .Data.Devices}}
                <div class="device-item">
                    <div class="device-icon device-icon-{{.DeviceType}}">
                        {{if eq .DeviceType "desktop"}}
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect width="20" height="14" x="2" y="3" rx="2"/>
                            <line x1="8" x2="16" y1="21" y2="21"/>
                            <line x1="12" x2="12" y1="17" y2="21"/>
                        </svg>
                        {{else if eq .DeviceType "mobile"}}
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect width="14" height="20" x="5" y="2" rx="2" ry="2"/>
                            <path d="M12 18h.01"/>
                        </svg>
                        {{else if eq .DeviceType "tablet"}}
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect width="16" height="20" x="4" y="2" rx="2" ry="2"/>
                            <line x1="12" x2="12.01" y1="18" y2="18"/>
                        </svg>
                        {{else}}
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 16v-4"/>
                            <path d="M12 8h.01"/>
                        </svg>
                        {{end}}
                    </div>
                    <div class="device-info">
                        <span class="device-type">{{.DeviceType}}</span>
                        <span class="device-percent">{{printf "%.1f" .Percent}}%</span>
                    </div>
                </div>
                {{end}}
            </div>
            {{else}}
            <div class="empty-state">
                <p>{{T .AdminLang "analytics_int.no_data"}}</p>
            </div>
            {{end}}
        </div>
    </div>

    <!-- Countries -->
    <div class="card">
        <div class="card-header">
            <h3>{{T .AdminLang "analytics_int.countries"}}</h3>
        </div>
        <div class="card-body">
            {{if .Data.Countries}}
            <div class="breakdown-list">
                {{range .Data.Countries}}
                <div class="breakdown-item">
                    <div class="breakdown-info">
                        <span class="breakdown-name">{{.CountryName}}</span>
                        <span class="breakdown-value">{{formatNumber .Views}} ({{printf "%.1f" .Percent}}%)</span>
                    </div>
                    <div class="breakdown-bar">
                        <div class="breakdown-fill breakdown-fill-geo" style="width: {{printf "%.0f" .Percent}}%"></div>
                    </div>
                </div>
                {{end}}
            </div>
            {{else}}
            <div class="empty-state">
                <p>{{T .AdminLang "analytics_int.no_geo_data"}}</p>
            </div>
            {{end}}
        </div>
    </div>
</div>

<!-- Settings -->
<div class="settings-section">
    <div class="card">
        <div class="card-header">
            <h3>{{T .AdminLang "analytics_int.settings"}}</h3>
        </div>
        <div class="card-body">
            <form method="POST" action="/admin/internal-analytics/settings">
                {{.CSRFField}}
                <div class="form-group">
                    <label class="form-check">
                        <input type="checkbox" name="enabled" value="1" {{if .Data.Settings.Enabled}}checked{{end}}>
                        <span>{{T .AdminLang "analytics_int.enabled"}}</span>
                    </label>
                    <p class="form-hint">{{T .AdminLang "analytics_int.enabled_hint"}}</p>
                </div>
                <div class="form-group">
                    <label>{{T .AdminLang "analytics_int.retention_days"}}</label>
                    <input type="number" name="retention_days" value="{{.Data.Settings.RetentionDays}}" min="30" max="730" class="form-control form-control-sm">
                    <p class="form-hint">{{T .AdminLang "analytics_int.retention_hint"}}</p>
                </div>
                <div class="form-group">
                    <label>{{T .AdminLang "analytics_int.exclude_paths"}}</label>
                    <textarea name="exclude_paths" rows="3" class="form-control" placeholder="/private&#10;/internal">{{range .Data.Settings.ExcludePaths}}{{.}}
{{end}}</textarea>
                    <p class="form-hint">{{T .AdminLang "analytics_int.exclude_hint"}}</p>
                </div>
                <button type="submit" class="btn btn-primary">{{T .AdminLang "analytics_int.save_settings"}}</button>
            </form>
            <hr class="mt-4 mb-4">
            <form method="POST" action="/admin/internal-analytics/aggregate">
                {{.CSRFField}}
                <div class="form-group">
                    <p class="form-hint mb-2">{{T .AdminLang "analytics_int.run_aggregation_hint"}}</p>
                    <button type="submit" class="btn btn-outline">{{T .AdminLang "analytics_int.run_aggregation"}}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Update real-time count every 30 seconds
setInterval(function() {
    fetch('/admin/internal-analytics/api/realtime')
        .then(response => response.json())
        .then(data => {
            const el = document.getElementById('realtime-count');
            if (el) {
                el.textContent = data.visitors;
            }
        })
        .catch(err => console.error('Failed to fetch realtime stats:', err));
}, 30000);
</script>
{{end}}
