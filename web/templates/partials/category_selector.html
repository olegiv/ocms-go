{{define "category_selector"}}
<div class="category-selector" x-data="categorySelector()" data-initial-categories='{{if .Data.Categories}}{{toJSON .Data.Categories}}{{else}}[]{{end}}'>
    <label class="form-label">{{T .AdminLang "categories.title"}}</label>

    {{if .Data.AllCategories}}
    <div class="category-tree">
        {{range .Data.AllCategories}}
        <div class="category-item" style="padding-left: {{multiply .Depth 20}}px;">
            <label class="category-checkbox">
                <input
                    type="checkbox"
                    name="categories[]"
                    value="{{.Category.ID}}"
                    :checked="isSelected({{.Category.ID}})"
                    @change="toggleCategory({{.Category.ID}})"
                >
                <span class="checkbox-indicator"></span>
                <span class="category-name">{{.Category.Name}}</span>
                {{if .Category.Description.Valid}}
                <span class="category-desc">{{truncate .Category.Description.String 30}}</span>
                {{end}}
            </label>
        </div>
        {{end}}
    </div>
    {{else}}
    <div class="category-empty">
        <p>{{T .AdminLang "categories.no_available"}}</p>
        <a href="/admin/categories/new" class="btn btn-sm btn-outline">{{T .AdminLang "categories.new"}}</a>
    </div>
    {{end}}

    <span class="form-hint">{{T .AdminLang "categories.select_hint"}}</span>
</div>
<script>
function categorySelector() {
    return {
        selectedCategories: [],

        init() {
            // Load initial categories from data attribute
            const container = this.$el;
            const initialCategories = container.dataset.initialCategories;
            if (initialCategories) {
                try {
                    const cats = JSON.parse(initialCategories);
                    this.selectedCategories = cats.map(c => c.id);
                } catch (e) {
                    console.error('Failed to parse initial categories:', e);
                }
            }
        },

        isSelected(categoryId) {
            return this.selectedCategories.includes(categoryId);
        },

        toggleCategory(categoryId) {
            if (this.isSelected(categoryId)) {
                this.selectedCategories = this.selectedCategories.filter(id => id !== categoryId);
            } else {
                this.selectedCategories.push(categoryId);
            }
        }
    }
}
</script>
{{end}}
